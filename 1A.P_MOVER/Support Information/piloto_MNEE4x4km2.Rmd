---
title: "As predições de MNEE em paisagens de 10x10km e de 4x4km diferem?"
author: "Danilo Pereira Mori"
date: '2022-03-19'
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: inline
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=FALSE)
knitr::opts_knit$set(root.dir = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/")
setwd("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/")
```

```{r pacotes,echo=TRUE}
library(sads)
library(ggpubr)
library(imager)
library(OpenImageR)
# library(cowplot)
library(twosamples)
library(doMC)
library(raster)
# library(GUILDS)
library(bbmle)
library(magrittr)
library(gridExtra)
library(ggplot2); theme_set(theme_classic())
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
select <- dplyr::select
```


Anteriormente eu havia rodado as simulações dos modelos neutros considerando paisagens de 10.2 x 10.2 km2, porém o sugerido pela análise de escala de efeito é 4.07 x 4.07 km2 (Fig. 1a). Em média, a redução da extensão espacial da paisagem aumentou a porcentagem de cobertura vegetal na paisagem, apesar de reduzi-la em alguns casos (Fig 1b). Para avaliar se as predições de MNEE são robustas a essa mudança selecionei alguns pontos para fazer um piloto (Fig 1b, pontos vermelhos).

RESUMO DOS ACHADOS:
1) há uma tendência de aumento da proporção de cobertura vegetal com 
  
### Fig 1: Análise de escala de efeito e mudança na % de cobertura vegetal entre escalas
  
```{r fig 1: dados e graficos, fig.width=10,fig.height=4,echo=FALSE, eval=TRUE}
# dados
## resultado da análise de escala de efeito:
df_averageSE <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/df_escalaEfeito_peso.csv",
                         header = TRUE)
raio_medio <- round(weighted.mean(x = df_averageSE$raio_paisagem,w = df_averageSE$weight),1)
raio_moda <- round(mean(df_averageSE$raio_paisagem[df_averageSE$dAICc==0]),2)
#
## pontos do piloto
df_piloto <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv", header = TRUE)
#
## resultado do recorte de paisagens
df_recorte <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
                       header = TRUE) %>% 
  mutate(class = ifelse(SiteCode %in% unique(df_piloto$SiteCode),"piloto","outros"))
## gráfico
l_p <- list()
l_p[[1]] <- df_averageSE %>% 
  ggplot(aes(x=raio_paisagem,y=weight)) +
  geom_line() +
  geom_vline(xintercept = c(raio_medio,raio_moda),color=c("red","darkgreen"),alpha=0.6) +
  labs(x="metade do lado da paisagem quadrada",y="Akaike's weight",title = "a) Análise de Escala de Efeito") +
  theme_classic()
l_p[[2]] <- df_recorte %>% 
  ggplot(aes(x=p_10x10,y=p_4x4)) +
  geom_abline(slope = 1,intercept = 0) +
  geom_smooth(method = "lm",formula = "y~0+x") +
  geom_point(aes(color=class)) +
  scale_color_manual(values = c("piloto" = "red",
                                "outros"="black")) + 
  labs(x="%CV 10x10km2 - ANTERIOR",y="%CV 4x4km2 - ATUAL",color="",title="b) Mudança na % de cobertura vegetal (%CV)")
grid.arrange(grobs=l_p,ncol=2)
```
__Fig. 1__ a) Análise de escala de efeito: No eixto y há o peso de evidência que a extensão espacial (eixo x) atribuiu à regressão do tipo S ~ offset(N) + p_i + p_i^2, S = riqueza de espécies, N = número de espécies, p_i = proporção de cobertura vegetal da extensão espacial i. b) Mudança na porcentagem de cobertura vegetal dos sítios: em x %CV com paisagens de 10.2x10.2 km2 e em y o mesmo para paisagens de 4.14x4.14 km2; a linha preta representa o 1:1 e a linha azul uma regressão linear com os novos pontos; os pontos vermelhos foram usados no piloto. A mudança na extensão espacial da paisagem resultou em aumento médio da %CV, apesar de alguns terem diminuído.
  
    
## Piloto  

No piloto 30 pontos de uma distribuição uniforme são sorteados entre 0 e 1 e selecionamos os sítios com menor diferença com a proporção de cobertura vegetal nas paisagens de 10x10km2. Com esses pontos refiz as simulações coalescente para estimar U e predizer as SADs.  
    
### Códigos do sorteio de sítios ao longo do gradiente de cobertura vegetal nas paisagens de 10x10km2    
  
```{r dados,message=FALSE,echo=FALSE,eval=FALSE,include=FALSE}
### dados ###
# leitura
df_resultados <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13]
# padronização
level_k <- as.character(unique(sort(as.numeric(df_resultados$k),decreasing = TRUE)))
df_resultados$k <- factor(df_resultados$k,levels = level_k)
levels(df_resultados$k)[19] <- "0.1"
# z score
f_z <- function(x){
  m <- base::mean(x,na.rm=FALSE)
  sd <- sd(x,na.rm=FALSE)
  output <- (x-m)/sd
  return(output)
} 
# names(df_resultados)
# str(df_resultados)
df_resultados %<>% mutate(diffS_gamma = diffS_mean + min(diffS_mean)*(-1) + 0.01,
                          modulo_diffS = abs(diffS_mean),
                          log_Sobs=log(S_obs))

df_resultados.z <- as.data.frame(apply(df_resultados[,c("p","Ntotal","log_Sobs","k_1","d_Lplot","d","modulo_diffS")],2,f_z))
names(df_resultados.z) <- sapply(names(df_resultados.z), function(x) paste0(x,".z"))
df_resultados %<>% cbind(.,df_resultados.z) %>% 
  select(-k_1,-k_1.z)
```

```{r sorteio de pontos para o piloto,echo=TRUE,eval=FALSE}
f_random_byVar <- function(x = df_resultados,
                           column_name = "p", 
                           n_sample = 30, 
                           i_seed = 260320223){
  # amostra de uma uniforme
  set.seed(i_seed)
  sample_points <- sort(runif(n = n_sample, min = 0, max = 1))
  # encontra os valores mais próoximos
  df_x <- filter(x,k==levels(x$k)[1],MN=="EE")
  f_index <- function(X=df_x,
                      name=column_name,
                      v_ref){
    which.min(abs(X[[column_name]] - v_ref))
  }
  # remove os sítios repetidos
  v_sites <- df_x[sapply(sample_points,function(y) f_index(v_ref=y)),"SiteCode"] %>% unique
  ## output:
  df_return <- filter(x,SiteCode %in% v_sites,MN=="EE")
  df_return$SiteCode <- factor(df_return$SiteCode)
  return(df_return)
}
df_piloto <- f_random_byVar(x=df_resultados)
write.csv(df_piloto,file = "./artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
          row.names = FALSE)
```


```{r graficos df_piloto,echo=FALSE,eval=FALSE,include=FALSE}
df_piloto <- read.csv(file="df_piloto.csv", header = TRUE)
# gráficos exploratóritos
df_piloto %>% 
  filter(k==unique(df_piloto$k)[1]) %>% 
  ggplot(aes(x=p,y=S_obs)) + 
  geom_point() +
  ggtitle(label="Sítios Sorteados") +
  labs(x="% Tree cover (p)",y="Species Richness")
```
  
    
### Códigos para recorte das paisagens  
    
É suficiente recortar os atuais mapas de 10x10km2 para mapas de 4x4km2, pois sempre é aplicado uma mudança na resolução que impõe que a densidade de pixels seja igual à densidade de indivíduos na área amostral. Assim, não é necessário partir dos mapas do Landsat8 que apresentam resolução comum para fazer o recorte.  
  
  
```{r recorte das paisagens para piloto,echo=TRUE,eval=FALSE}
f_recorte <- function(file_path){
  # matriz da paisagem de 10x10km:
  mat_paisagem <- read.table(file=file_path, 
                             sep=" ",
                             header=TRUE) %>% 
    as.matrix
  #redução proporcional no número de linhas e colunas da matriz:
  v_dim_novo <- dim(mat_paisagem) - round(dim(mat_paisagem) * (4.14/10.2),0)
  v_dim <- dim(mat_paisagem)
  # recorte:
  mat_paisagem_output <- mat_paisagem[floor(v_dim_novo[1]/2):(v_dim[1]-1-ceiling(v_dim_novo[1]/2)),
                                      floor(v_dim_novo[2]/2):(v_dim[2]-1-ceiling(v_dim_novo[2]/2))]
  ## outputs:
  # salva a nova paisagem
  write.table(mat_paisagem_output, 
              file=gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        file_path),
              sep=" ", 
              row.names = FALSE,col.names = FALSE)
  tree.cover <- as.vector(mat_paisagem_output)
  p <- 1 - length(tree.cover[tree.cover==0])/length(tree.cover)
  # e retorna a atual proporção de cobertura vegetal
  return(p) 
}
registerDoMC(3)
p_4x4 <- aaply(df_$txt.name,1,f_recorte,.parallel = TRUE)
```
  
    
### Comparação paisagem de 10x10 km2 e de 4x4 km2  
  
```{r fig 2 comparacao mesma paisagem diferentes escalas}

```

__Fig 2__ Exemplo de recorte da paisagem ao redor, no material suplementar há para os 23 sítios amostrados para o piloto.  

### Esforço Computacional

ADICIONAR: tabela com o tempo de execução 
  
    
## Comparação U e SADs preditas congruentes   
    
```{r comparacao U,warning=FALSE,message=FALSE,eval=TRUE,include=TRUE,echo=FALSE}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv,show_col_types = FALSE)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_Umed <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k")) %>% 
  mutate(diff_Umed = U_med - U_med_10x10)
l_p <- list()
l_p[[1]] <- df_Umed %>% 
  ggplot(aes(x=U_med_10x10,y=U_med)) +
  geom_abline(intercept = 0,slope = 1,color="red",alpha=0.6) +
  geom_smooth(method = "lm",formula = "y~0+x",alpha=0.5) +
  geom_point(alpha=0.5) + 
  labs(x="U 10x10 km2 - ANTERIOR", y="U 4x4 km2 - ATUAL",title="a) lm(ATUAL ~ offset(ANTERIOR))?")
l_p[[2]] <- df_Umed %>% 
  ggplot(aes(x="",y=diff_Umed)) +
  geom_boxplot() +
  geom_jitter() + labs(x="", y="",title="b) ATUAL - ANTERIOR")
grid.arrange(grobs=l_p,ncol=2)
```
__Fig. 3__ Gráficos exploratórios da média da taxa U, estimada por MNEE. a) a linha vermelha representa a relação 1:1 e a linha azul uma regressão linear padrão da função ggplot2::geom_smooth() sem intercepto. b) boxplot da diferença.  
    
__Sumário padrão da regressão linear__    
      
```{r comparacao de U selecao de modelos,echo=TRUE,eval=TRUE}
summary(lm(U_med ~ U_med_10x10-1,data = df_Umed))
```
Os resultados sugerem que não há diferenças significativas entre as estimativas de U.  



  

#### Estimativa de U



```{r simulacao U}
# replicas
n_rep.U <- 10
func1 <- function(x,replicas=n_rep.U) {
  x$U <- NA
  x <- x[rep(1:dim(x)[1],each=replicas),]
}
# nomes
df_simulacao.U <- df_sims %>% func1()
####################
# simulacao
## objetos necessarios
# system(paste0("mkdir ",getwd(),"/U")) # pasta para armazenar os data.frames, só faz uma vez
k_factor <- unique(df_simulacao.U$k) # dividi as simulações por blocos de cenário de limitação
registerDoMC(3)
for(a in 1:length(k_factor)){
  df_simU <- df_simulacao.U %>% dplyr::filter(k == k_factor[a])
  op <- options(digits.secs=6)
  funcao_imigracao <- function(i,df_temp=df_simU){
    aviao <- list()
    aviao <- dinamica_coalescente(U = 1.25e-06,
                                  S = df_temp[i,"S_obs"],
                                  N_simul = 1,
                                  seed = as.numeric(Sys.time()),
                                  disp_range = df_temp[i,"d"],
                                  disp_kernel = df_temp[i,"kernel_code"],
                                  landscape = df_temp[i,"txt.name"])
    return(aviao$U_est)
  }
  replica.sim <- as.list(1:dim(df_simU)[1])
  sim.coal_U <- llply(.data = replica.sim, .fun = funcao_imigracao, .parallel = TRUE)
  df_simU[,"U"] <- unlist(sim.coal_U)
  write.csv(df_simU,
            file=paste0("./U/","df_simU__k",k_factor[a],".csv"),row.names = FALSE)
}
```

A simulação ocorreu entre 19h58 e 21h11, totalizando 1h13. Se considerarmos 103 sítios, serão 5h45. Pras SADS eu estimo que seja fique 54h49, 2.27 dias.

```{r comparacao U}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_Umed <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k")) %>% 
  mutate(diff_Umed = U_med - U_med_10x10)
l_p <- list()
l_p[[1]] <- df_Umed %>% 
  ggplot(aes(x=U_med_10x10,y=U_med)) +
  geom_abline(intercept = 0,slope = 1,color="red",alpha=0.6) +
  geom_point()
l_p[[2]] <- df_Umed %>% 
  ggplot(aes(x="",y=diff_Umed)) +
  geom_jitter()
grid.arrange(grobs=l_p,ncol=2)
```


#### SADs preditas

```{r SADs preditas}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_simulacao <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k"))
# system(paste0("mkdir ",getwd(),"/SADs_preditas")) # pasta para armazenar os data.frames, só faz uma vez
n_rep.SAD <- 100
f_simulacao <- function(i,df_=df_simulacao){
  X <- df_[i,] %>% as.data.frame()
  mat_sim <- dinamica_coalescente(U = X[,"U_med"],
                                  S = 0,
                                  N_simul = n_rep.SAD,
                                  seed = as.numeric(Sys.time()),
                                  disp_range = X[,"d"],
                                  disp_kernel = X[,"kernel_code"],
                                  landscape = X[,"txt.name"])
  df_SAD.replica <- bind_rows(alply(mat_sim,1,function(Y) data.frame(N = sort(as.integer(table(Y))) ) ),
                              .id = "replica")
  df_SAD.replica %<>% 
    mutate(SiteCode = X$SiteCode, MN = "EE", k = X$k)
  path.file <- paste0("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/",
                      X[,"SiteCode"],
                      "_k",X[,"k"],
                      "_EE.csv")
  write.csv(df_SAD.replica,
            file = path.file,
            row.names = FALSE)
}
registerDoMC(3)
simulacao <- as.list(1:dim(df_simulacao)[1])
l_ply(simulacao,f_simulacao,.parallel = TRUE)
```

As simulações das SADs ocorreram entre 23h10 e 00h30

##### teste KS

```{r dados para teste KS,echo=FALSE,eval=FALSE}
### dados e preparação
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_resultados <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k")) %>% 
  mutate(diff_Umed = U_med - U_med_10x10)
## SAD obs
df_SAD.obs <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/dados_para_iniciar_artigo/abundances.csv",
                       header = TRUE,as.is = TRUE)
df_SAD.obs %<>% filter(SiteCode %in% unique(df_resultados$SiteCode))
# f_write <- function(df_){
#   df_tWrite <- df_[,c("SiteCode","species.correct","N")]
#   path_ <- paste0("/home/danilo/Documentos/Doutorado/artigo_mestrado/1A.P_MOVER/simulacao/SAD_observada/SADobs_",
#                   df_tWrite$SiteCode[1],".csv")
#   write.csv(df_tWrite,path_,row.names = FALSE)
# }
# registerDoMC(3)
# d_ply(df_SAD.obs,"SiteCode",f_write,.parallel = TRUE)
df_SAD.obs %<>% group_by(SiteCode) %>% nest %>% rename(SAD_obs=data)
## SAD replica
df_SADreplica <- Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/*.csv") %>% 
  gsub("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/|.csv|_EE","",.) %>% 
  adply(.,1,function(x) unname( unlist( strsplit(x,"_k",fixed = TRUE))),.id = NULL) %>% 
  rename(SiteCode = V1,k = V2)
df_SADreplica$file_path <- Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/*.csv")
df_SADreplica %<>% group_by(SiteCode) %>% nest %>% rename(SAD_MN=data)
## merge
df_SADs <- inner_join(y=df_SADreplica,
                      x=df_SAD.obs,
                      by="SiteCode")

### rotina de testes
df_SADs$resultados <- vector("list",length = nrow(df_SADs))
registerDoMC(3)
for(i in 1:nrow(df_SADs)){
  X <- df_SADs[i,]
  v_SADobs <- X$SAD_obs[[1]]$N
  # v_MN <- df_SADs$SAD_MN[1]
  f_KS <- function(v_obs=v_SADobs,v_MN,boots=200){
    testeKS <- ks_test(a=v_obs,b = v_MN, nboots = boots)
    a <- data.frame(D_KSboot=testeKS[1],p.valor_KSboot=testeKS[2])
    a$S_SAD.predita <- length(v_MN)
    a$S_SAD.obs <- length(v_obs)
    return(a)
  }
  df_predicao <- X$SAD_MN[[1]] %>% as.data.frame()
  f_resultados <- function(path_df,parallel_=FALSE){
    # path_df <- df_predicao$file_path[1]
    df_SAD.MN <- read.csv(path_df,header = TRUE,as.is = TRUE)
    df_return <- ddply(df_SAD.MN,"replica",function(Y) f_KS(v_MN=Y$N),.parallel = parallel_)
    df_return %<>% mutate(SiteCode = df_SAD.MN$SiteCode[1], 
                          MN = df_SAD.MN$MN[1], 
                          k = df_SAD.MN$k[1])
    return(df_return)
  }
  df_SADs$resultados[[i]] <- adply(df_predicao,1,
                                   function(line) f_resultados(path_df = line$file_path),.parallel = TRUE)
}
for(i in 1:nrow(df_SADs)){
  df_SADs$resultados[[i]]$replica <- as.character(df_SADs$resultados[[i]]$replica)
}
df_replicas <- df_SADs %>% rename(Site = SiteCode) %>% 
  select(resultados) %>% unnest(cols=c(resultados)) %>% as.data.frame() %>% 
  select(SiteCode,MN,k,replica,D_KSboot,p.valor_KSboot,S_SAD.predita,S_SAD.obs)
write.csv(df_replicas,
          file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_replicas.csv",
          row.names = FALSE)
```

```{r summarise replicas teste KS}
# dados
df_replicas <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_replicas.csv",
                        header = TRUE,as.is = TRUE)
df_replicas %<>% mutate(diff_S = (S_SAD.predita - S_SAD.obs)/S_SAD.obs)
# sumarização
alpha <- 0.05
f_maxRank <- function(obs,predito){
  max_rank <- max(c(obs,predito))
  return(max_rank)
}
registerDoMC(3)
df_resultados <- ddply(df_replicas,c("MN","k","SiteCode"),summarise,
                       # D_mean = mean(D_KSboot), D_var = var(D_KSboot),
                       # p.value_mean = mean(p.valor_KSboot),p.value_var = var(p.valor_KSboot),
                       # S.MN_mean = mean(S_SAD.predita), S.MN_var = var(S_SAD.predita),
                       S.obs_mean = mean(S_SAD.obs),
                       # S.obs_var = var(S_SAD.obs),
                       diffS_mean = mean(diff_S),diffS_var = var(diff_S),
                       n_nRef = sum(p.valor_KSboot>=alpha), n_Ref = sum(p.valor_KSboot<alpha),
                       # max_rank = f_maxRank(obs=S_SAD.obs,predito=S_SAD.predita),
                       .parallel = TRUE)
write.csv(df_resultados,
          "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultados.csv",
          row.names = FALSE)
```

# Material Suplementar

##### Recorte das paisagens de 10x10km para 4x4km

Todas as paisagens foram recortadas e armazenadas na pasta do piloto

```{r recorte das paisagens para piloto,echo=FALSE}
df_sims <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/df_simulacao.csv",
                    header = TRUE) %>% 
  select(!(U_med:theta)) %>% filter(k==0.05)
# names(df_sims)[10:11] <- paste0(names(df_sims)[10:11],"_10x10")
# estudo funcao
# file_path <- df_sims$txt.name[3]
f_recorte <- function(file_path){
  mat_paisagem <- read.table(file=file_path,sep=" ",header=TRUE) %>% 
    as.matrix
  v_dim_novo <- dim(mat_paisagem) - round(dim(mat_paisagem) * (4.14/10.2),0)
  v_dim <- dim(mat_paisagem)
  mat_paisagem_output <- mat_paisagem[floor(v_dim_novo[1]/2):(v_dim[1]-1-ceiling(v_dim_novo[1]/2)),
                                      floor(v_dim_novo[2]/2):(v_dim[2]-1-ceiling(v_dim_novo[2]/2))]
  write.table(mat_paisagem_output,
              file=gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        file_path),
              sep=" ", 
              row.names = FALSE,col.names = FALSE)
  tree.cover <- as.vector(mat_paisagem_output)
  p <- 1 - length(tree.cover[tree.cover==0])/length(tree.cover)
  return(p)
}
# image(mat_paisagem)
df_sims$p_4x4 <- aaply(df_sims$txt.name,1,f_recorte)
# df_sims %>%
#   ggplot(aes(x=p,y=p_4x4)) +
#   geom_abline(slope = 1,intercept = 0,color="red",alpha=0.6) +
#   geom_point()
###
df_sims %>% 
  select(SiteCode, p_4x4, p) %>% 
  rename(p_10x10 = p) %>% 
  write.csv(x=.,
            file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
            row.names = FALSE)
# plotar todos os paineis
df_sims %>% 
  mutate(txt.name_antigo = txt.name,
         txt.name = gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        txt.name_antigo))
write.csv(df_sims,
          file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
          row.names=FALSE)
# "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/"
```

##### Ap Final BIE 5770: inicio

Gráficos usados na apresentação final de BIE 5770: ano da amostragem das SADs e ano referência do mapa de cobertura vegetal.


```{r gráficos}
#
df_SADs.disponiveis <- read.csv(
  "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/dados_para_iniciar_artigo/df_SADs_disponiveis.csv",
  header =T)
df_SADs.disponiveis %<>% 
  filter(method=="parcelas" &
           grepl("*contiguous*",arrangement) & 
           effort_ha>=1 &
           grepl("*yes*",status) & 
           grepl("ok*",status_diagnostico) &
           grepl("Atlantic_Forest*",domain) &
           dbh_cutoff %in% c("PBH>=15.0cm","PBH>=15.7cm",
                             "DBH>=5.0cm","DGH>=5.0cm","DBH>5.0cm",
                             "DBH>=4.8cm",
                             "DBH>=5.0cm&H>300cm","DBH>=5.0cm&H>500cm", 
                             "DGH30>=5.0cm")
         )
# df_SADs.disponiveis %>%
#   select(status_diagnostico:effort_ha) %>% 
#   select(-c(state,samples))


## dados disponíveis: usando landsat8 (ano referência 2000)
df_S1 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/tabelaSI1.csv",
                  header = TRUE) %>% 
  mutate(year_plot = ifelse(is.na(year_data),year,year_data))
df_S1$year_plot[df_S1$year_plot=="2012_2013"] <- "2012.5"
df_S1$year_plot <- as.numeric(df_S1$year_plot)
### Filtros usados
### filtro universidades e campi
# df_filtro.UC <- df_1ofiltro %>% 
#   filter(UC_area_ha >= 1000 | 
#          Unidade_de_conservacao %in% c("UC Protecao Integral","universities and research centers"))
# ### filtro estados
# df_filtro.estate <- filter(df_1ofiltro,state %in% c("RJ","RS") & year >= 1990)
# df_filtro.estate %<>% rbind(.,filter(df_1ofiltro,state %in% c("BA","GO","MS") & year >= 2000))
# df_filtro.estate %<>% rbind(.,filter(df_1ofiltro,!(state %in% c("BA","GO","MS","RJ","RS")) & year >= 1995))
df_S1$site_category <- NA
df_S1$site_category[df_S1$UC_area_ha>=1000 | 
                      df_S1$Unidade_de_conservacao %in% 
                      c("UC Protecao Integral","universities and research centers")] <- 1
df_S1$site_category[df_S1$state %in% c("RJ","RS") & 
                      df_S1$year >= 1990] <- 2
df_S1$site_category[df_S1$state %in% c("BA","GO","MS") & 
                      df_S1$year >= 2000] <- 3
df_S1$site_category[!(df_S1$state %in% c("BA","GO","MS","RJ","RS")) & 
                      df_S1$year >= 1995] <- 4
df_S1 %>%
  mutate(site_category = factor(site_category)) %>% 
  ggplot(aes(x=year_plot,y=site_category,shape=site_category)) +
  # geom_vline(xintercept = 2000,color="red") + # versão 1
  geom_vline(aes(xintercept = year_plot),color="red",alpha=0.3) + # versão 2
  # geom_boxplot() +
  geom_jitter() +
  labs(shape="Categorias:",
       y="categoria inventário florestal",
       x="ano inventário florestal",
       title= "104 inventários dentro dos critérios (de 109 confiáveis)") +
  scale_shape_discrete(breaks=c("1","2","3","4"),
                       labels=c("todas as idades: \nUC Prot. Int. | Univ. | UC>=1000 ha",
                                "RJ e RS >= 1990",
                                "BA, GO e MS >= 2000",
                                "outros estados Brasil >= 1995")) +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
# df_S1 %>% arrange(year_plot) %>% select(year_plot,UC_area_ha,state)
```

```{r}
df_S2 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/tabelaSI2.csv",
                  header = TRUE) %>% 
  mutate(year_plot = ifelse(is.na(year_data),year,year_data))
df_S2$year_plot[df_S2$year_plot=="2012_2013"] <- "2012.5"
df_S2$year_plot <- as.numeric(df_S2$year_plot)
df_S2$site_category <- "1"
df_S2 %>%
  mutate(site_category = factor(site_category)) %>% 
  ggplot(aes(x=year_plot,y=site_category,shape=site_category)) +
  geom_vline(aes(xintercept = year_plot),color="red",alpha=0.6) + # versão 2
  # geom_boxplot() +
  geom_jitter() +
  labs(shape="",
       y="",
       x="ano inventário florestal",
       title= "109 inventários com SAD e coordenada confiáveis") +
  scale_shape_discrete(breaks="") +
                       # labels="- Atlantic Forest \n- DBH >= 5.0cm \n- plot >= 1ha") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

#### Escala de Efeito

```{r selecao da escala espacial, echo=TRUE}
df_se <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/df_escalaEfeito.csv",header = T)
# ajuste de modelos aos dados
library(MASS)
f_glm.nb <- function(data_){
  md_ <- glm.nb(S_obs ~ p + I(p^2) + offset(log(Ntotal)), data = data_)
}
registerDoMC(3)
l_md <- dlply(df_se,"raio_km",f_glm.nb,.parallel = TRUE)
# média ponderada dos raios pelo peso de evidência
df_averageSE <- print(AICctab(l_md,weights=TRUE)) %>% 
  as.data.frame()
df_averageSE$raio_paisagem <- row.names(df_averageSE) %>% as.numeric()
df_averageSE$weight <- as.numeric(as.character(df_averageSE$weight))
df_averageSE$dAICc <- as.numeric(as.character(df_averageSE$dAICc))
# (raio_medio <- round(weighted.mean(x = df_averageSE$raio_paisagem,w = df_averageSE$weight),1))  
raio_medio <- mean(df_averageSE %>% filter(dAICc==0) %>% .$raio_paisagem)
df_averageSE %>% 
  # mutate(diff_moda = max(df_averageSE$weight) - weight) %>% 
  # filter(diff_moda < 0.0005) %>% dim
  ggplot(aes(x=raio_paisagem,y=weight)) +
  geom_line() + 
  geom_vline(xintercept = raio_medio,color="red",alpha=0.5) + 
  annotate(geom="text",x=raio_medio+1.3,y=0.002,label=paste0("raio médio = ",raio_medio," km"),size=3) +
  theme_classic()
```

O raio médio = `r raio_medio` (2.07) e portanto o lado da paisagem é de `r 2*raio_medio`km e área total de 1713.96 hectares  
  
O lado anterior é de 10.2x10.2, o lado atual é 4.14x4.14.
