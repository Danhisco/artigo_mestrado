---
title: "Piloto e atualização dos resultados de MNEE para paisagens de 4x4 km2"
author: "Danilo Pereira Mori"
date: '2022-03-19'
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: inline
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=TRUE,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=FALSE)
knitr::opts_knit$set(root.dir = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/")
setwd("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/")
```

```{r pacotes}
library(sads)
library(metR)
library(ggpubr)
library(imager)
library(OpenImageR)
library(cowplot)
library(twosamples)
library(doMC)
library(raster)
library(grid)
library(bbmle)
library(magrittr)
library(gridExtra)
library(ggplot2); theme_set(theme_classic())
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
select <- dplyr::select
```
```{r dados mesmo,message=FALSE,warning=FALSE,include=TRUE,eval=TRUE}
### dados ###
# leitura
df_resultados <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13]
df_p_4_10 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
                       header = TRUE) %>% 
  dplyr::select(-p_10x10)
df_resultados <- left_join(x=df_resultados,
                           y=df_p_4_10,
                           by="SiteCode") %>% 
  rename(p_10x10=p,
         p=p_4x4)
# padronização
level_k <- as.character(unique(sort(as.numeric(df_resultados$k),decreasing = TRUE)))
df_resultados$k <- factor(df_resultados$k,levels = level_k)
levels(df_resultados$k)[19] <- "0.1"
# z score
f_z <- function(x){
  m <- base::mean(x,na.rm=FALSE)
  sd <- sd(x,na.rm=FALSE)
  output <- (x-m)/sd
  return(output)
} 
# names(df_resultados)
# str(df_resultados)
df_resultados %<>% mutate(diffS_gamma = diffS_mean + min(diffS_mean)*(-1) + 0.01,
                          modulo_diffS = abs(diffS_mean),
                          log10_Sobs=log10(S_obs),
                          log10_U = log10(U_med),
                          log10_d = log10(d))

df_resultados.z <- as.data.frame(apply(df_resultados[,c("p","p_10x10","Ntotal","log10_Sobs","k_1","d_Lplot","d","log10_d","modulo_diffS")],2,f_z))
names(df_resultados.z) <- sapply(names(df_resultados.z), function(x) paste0(x,".z"))
df_resultados %<>% cbind(.,df_resultados.z) %>% 
  dplyr::select(-k_1,-k_1.z)
###############
df_U <- df_resultados %>% 
  filter(MN=="EE") %>%  
  dplyr::select(U_med,log10_U,SiteCode,k,d,d.z,p,p.z,log10_Sobs,log10_Sobs.z,log10_d,log10_d.z) %>% 
  distinct 
#%>% 
  # mutate(log10_Sobs = log10(S_obs),
         # log10_U = log10(U_med))
```


### Resumo
  
Anteriormente as simulações consideraram paisagens de 10.2 x 10.2 km2, porém o sugerido pela análise de escala de efeito é 4.07 x 4.07 km2 (Fig. 1a). Em média, a redução da extensão espacial da paisagem aumentou a porcentagem de cobertura vegetal na paisagem, apesar de reduzi-la em alguns casos, modificando a ordenação dos sítios ao longo do gradiente de cobertura vegetal (Fig 1b). Para avaliar se as predições de MNEE são robustas a essa mudança selecionei alguns pontos para fazer um piloto (Fig 1b pontos vermelhos e Fig 2 para exemplo). O tempo de execução das simulações foi bem mais rápido do que eu esperava (tabela 1). Conclui que as mudanças não eram significantes (Fig. 3, 4 e 5) e segui atualizando os modelos estatístiscos com a nova ordenação dos sítios ao longo do gradiente (Fig. 6 e 7). A atualização dos modelos estatísticos e suas figuras levou cerca de 7 horas (GLMM, GAMM e pausas). Nos GLMM cheios que rodei com a variável para 10x10 km2, os coeficientes de determinação apresentaram valores maiores do que esta no texto (tabela 2), achei estranho. Em comparação ao que tava no texto eles são maiores, porém com relação aos da variável de 4x4 km2 são similares (tabela 2) - eu verifiquei que são as variávies corretas e as figuras 6 e 7 confirmam que houveram mudanças. As figuras principais de predito pelo modelo médio para novo conjunto de dados se mantém qualitativamente iguais (Figs 6 e 7).
  

### Análise de escala de efeito e mudança na % de cobertura vegetal entre escalas  
    
      
```{r fig 1: dados e graficos, fig.width=10,fig.height=4,echo=FALSE, eval=TRUE}
# dados
## resultado da análise de escala de efeito:
df_averageSE <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/df_escalaEfeito_peso.csv",
                         header = TRUE)
raio_medio <- round(weighted.mean(x = df_averageSE$raio_paisagem,w = df_averageSE$weight),1)
raio_moda <- round(mean(df_averageSE$raio_paisagem[df_averageSE$dAICc==0]),2)
#
## pontos do piloto
df_piloto <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv", header = TRUE)
#
## resultado do recorte de paisagens
df_recorte <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
                       header = TRUE) %>% 
  mutate(class = ifelse(SiteCode %in% unique(df_piloto$SiteCode),"piloto","outros"))
## gráfico
l_p <- list()
l_p[[1]] <- df_averageSE %>% 
  ggplot(aes(x=raio_paisagem,y=weight)) +
  geom_line() +
  geom_vline(xintercept = c(raio_medio,raio_moda),color=c("red","darkgreen"),alpha=0.6) +
  labs(x="metade do lado da paisagem quadrada",y="Akaike's weight",title = "a) Análise de Escala de Efeito") +
  theme_classic()
l_p[[2]] <- df_recorte %>% 
  ggplot(aes(x=p_10x10,y=p_4x4)) +
  geom_abline(slope = 1,intercept = 0) +
  geom_smooth(method = "lm",formula = "y~0+x") +
  geom_point(aes(color=class)) +
  scale_color_manual(values = c("piloto" = "red",
                                "outros"="black")) + 
  labs(x="%CV 10x10km2 - ANTERIOR",y="%CV 4x4km2 - ATUAL",color="",title="b) Mudança na % de cobertura vegetal (%CV)")
grid.arrange(grobs=l_p,ncol=2)
```
  
__Fig. 1__ a) Análise de escala de efeito: No eixto y há o peso de evidência que a extensão espacial (eixo x) atribuiu à regressão do tipo S ~ offset(N) + p_i + p_i^2, S = riqueza de espécies, N = número de espécies, p_i = proporção de cobertura vegetal da extensão espacial i. b) Mudança na porcentagem de cobertura vegetal dos sítios: em x %CV com paisagens de 10.2x10.2 km2 e em y o mesmo para paisagens de 4.14x4.14 km2; a linha preta representa o 1:1 e a linha azul uma regressão linear com os novos pontos; os pontos vermelhos foram usados no piloto. A mudança na extensão espacial da paisagem resultou em aumento médio da %CV, apesar de alguns terem diminuído.
  
    
### Piloto  
  
    
Fiz um sorteio de 30 pontos de uma distribuição uniforme entre 0 e 1 e selecionamos os sítios com menor diferença com a proporção de cobertura vegetal nas paisagens de 10x10km2. Excluindo os pontos repetidos, usei 23 sítios. Com esses pontos refiz as simulações coalescente para estimar U e predizer as SADs. Recortei os atuais mapas de 10x10km2 para mapas de 4x4km2.    
  
    
      
#### Comparação paisagem de 4x4 km2 e de 10x10 km2
      
```{r fig 2 comparacao mesma paisagem diferentes escalas,eval=TRUE,include=TRUE,fig.height=4,fig.width=8}
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_plot <- df_sims[3,] %>% 
  dplyr::select(SiteCode,txt.name,txt.name_antigo) #%>% 
  # rename(scale_4x4=txt.name,
  #        scale_10x10=txt.name_antigo) %>% 
  # pivot_longer(!SiteCode,names_to = "scale",values_to = "path_file")
mat_4x4 <- read.table(df_plot[,"txt.name"],sep=" ",header=TRUE) %>% 
  as.matrix()
mat_10x10 <- read.table(df_plot[,"txt.name_antigo"],sep=" ",header=TRUE) %>% 
  as.matrix()
#
par(mfrow=c(1,2))
par(mai=c(0,0,0.5,0))
image(mat_4x4,
      main="4x4 km2",
      col=terrain.colors(12,rev = TRUE),
      axes=FALSE)
image(mat_10x10,
      main="10x10 km2",
      col=terrain.colors(12,rev = TRUE),
      axes=FALSE)
```
  
__Fig 2__ Exemplo de recorte da paisagem ao redor.    

  
    
#### Esforço computacional das simulações

<!-- ADICIONAR: tabela com o tempo de execução  -->
<!-- - A simulação de U ocorreu entre 19h58 e 21h11, totalizando 1h13. Se considerarmos 103 sítios, serão 5h45. Pras SADS eu estimo que seja fique 54h49, 2.27 dias. -->
<!-- - As simulações das SADs ocorreram entre 23h10 e 00h30, totalizando 1h20 - similar à estimativa de U.   -->
<!-- - A rotina de testes KS ocorreu entre 00h05 e 00h23   -->

__Tabela 1__ Uso Computacional observado (minutos, n=23) e estimado (horas, n=103)

```{r tabela 1 esforco computacional, eval=TRUE,include=TRUE}
library(kableExtra)
# library(ggpubr)
# library(ggstance)
df_esforcoComputacional <- data.frame(item = c("Sim. U","Sim. SADs","teste KS"),
                                      minutos = c(73,80,18)) %>% 
  mutate(min_todosSitios = minutos*103/23,horas = round(min_todosSitios/60,2)) %>% dplyr::select(-min_todosSitios)
# kable(df_esforcoComputacional,
#       # caption = "Uso Computacional observado (n=23) e estimado (n=103)",
#       col.names = c("","min", "h"))
df_esforcoComputacional

```

        
          
### Comparação variáveis respostas   
  
  
#### Estimativas de U  
   
     
```{r Fig 3 comparacao U,warning=FALSE,message=FALSE,eval=TRUE,include=TRUE,echo=FALSE,fig.height=4,fig.width=8}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv,show_col_types = FALSE)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_Umed <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k")) %>% 
  mutate(diff_Umed = U_med - U_med_10x10)
l_p <- list()
l_p[[1]] <- df_Umed %>% 
  ggplot(aes(x=U_med_10x10,y=U_med)) +
  geom_abline(intercept = 0,slope = 1,color="red",alpha=0.6) +
  geom_smooth(method = "lm",formula = "y~0+x",alpha=0.5) +
  geom_point(alpha=0.5) + 
  labs(x="U 10x10 km2 - ANTERIOR", y="U 4x4 km2 - ATUAL",title="a) lm(ATUAL ~ ANTERIOR-1)")
l_p[[2]] <- df_Umed %>% 
  ggplot(aes(x="",y=diff_Umed)) +
  geom_boxplot() +
  geom_jitter() + labs(x="", y="",title="b) ATUAL - ANTERIOR")
grid.arrange(grobs=l_p,ncol=2)
```
  
    
__Fig. 3__ Gráficos exploratórios da média da taxa U, estimada por MNEE. a) a linha vermelha representa a relação 1:1 e a linha azul uma regressão linear padrão da função ggplot2::geom_smooth() sem intercepto. b) boxplot da diferença.   
  
    
          
__Desvio-padrão das estimativas de U: U_med10x10 = anteriores; U_med = atuais; e diff_Umed = diferença entre atual e anterior__       
     
```{r desvio padrao dos U,echo=TRUE,eval=TRUE}
apply(df_Umed[,c("U_med_10x10","U_med","diff_Umed")],2,sd)
```
  
  
  
__Sumário padrão da regressão linear__    
       
```{r comparacao de U selecao de modelos,echo=TRUE,eval=TRUE}
summary(lm(U_med ~ U_med_10x10-1,data = df_Umed))
```
    
      
Os resultados sugerem que não há diferenças significativas entre as simulações feitas nas paisagens de 10.2x10.2 km2 e de 4.14x4.14 km2.      
      
        
#### SADs preditas congruentes           
  
    
```{r Fig 4 comparacao SADs preditas congruentes,fig.height=4,fig.width=8,eval=TRUE,include=TRUE}
df_SADsCongruentes <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultados.csv",
                               header = TRUE) %>% 
  dplyr::select(SiteCode,k,n_nRef)
# df_SADsCongruentes <- df_SADsCongruentes[,c("SiteCode","k","n_nRef")]

df_resultados_antigos <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13] %>% 
  filter(SiteCode %in% unique(df_SADsCongruentes$SiteCode), MN == "EE") %>% 
  dplyr::select(SiteCode,k,n_nRef) %>% 
  rename(n_nRef_10x10 = n_nRef)
df_SADsCongruentes <- inner_join(x=df_SADsCongruentes,
                                 y=df_resultados_antigos,
                                 by=c("SiteCode","k")) %>% 
  mutate(diff_SADs = n_nRef - n_nRef_10x10)
l_p <- list()
l_p[[1]] <- df_SADsCongruentes %>% 
  ggplot(aes(x=n_nRef_10x10,y=n_nRef)) +
  geom_abline(intercept = 0,slope = 1,color="red",alpha=0.6) +
  geom_smooth(method = "lm",formula = "y~0+x",alpha=0.5) +
  geom_point(alpha=0.5) + 
  labs(x="#Congruentes 10x10 km2 - ANTERIOR", y="#Congruentes 4x4 km2 - ATUAL",title="a) lm(ATUAL ~ ANTERIOR-1)") #+
  # facet_wrap(~k,ncol=4)
l_p[[2]] <- df_SADsCongruentes %>% 
  ggplot(aes(x="",y=diff_SADs)) +
  geom_boxplot() +
  geom_jitter() + labs(x="", y="",title="b) ATUAL - ANTERIOR")
grid.arrange(grobs=l_p,ncol=2)
```
  
    
__Fig. 4__ Gráficos exploratórios do número de SADs preditas por MNEE que são congruentes segundo o teste KS (#Congruentes) a) a linha vermelha representa a relação 1:1 e a linha azul uma regressão linear padrão da função ggplot2::geom_smooth() sem intercepto. b) boxplot da diferença. O ponto que mais diferiu ocorreu no cenário de limitação a dispersão menos severo.
  
         
__Desvio-padrão das estimativas de U: U_med10x10 = anteriores; U_med = atuais; e diff_Umed = diferença entre atual e anterior__      
      
        
```{r desvio padrao SADs,echo=TRUE,eval=TRUE}
apply(df_SADsCongruentes[,3:5],2,sd)
```
  
    
__Sumário padrão da regressão linear__      
          
          
```{r summary de lm SADs comparacao,echo=TRUE,eval=TRUE}
summary(lm(n_nRef ~ n_nRef_10x10-1,data = df_SADsCongruentes))
```  
    
    
Apesar de ter aparente maior variabilidade, o número de SADs congruentes também é robusto à mudança na escala da paisagem.     
  
    
#### Relação com outras preditoras
  
    
```{r criacao df_resultadosPiloto,echo=FALSE,eval=FALSE,include=FALSE}
select <- dplyr::select
# dados de proporção de cobertura vegetal e U_med anterior
df_p <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE) %>% select(SiteCode,k,p,p2,U_med_10x10) %>% 
  rename(p_10x10 = p, p_4x4=p2)
# dados das simulações do piloto para estimar U
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv,show_col_types = FALSE)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med_4x4 = mean(U),
        U_var = var(U))
# SADs congruentes
df_SADsCongruentes <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultados.csv",
                               header = TRUE) %>% 
  dplyr::select(SiteCode,k,n_nRef) %>% 
  rename(n_cong_4x4 = n_nRef)
df_resultados_antigos <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13] %>% 
  filter(SiteCode %in% unique(df_SADsCongruentes$SiteCode), MN == "EE") %>% 
  dplyr::select(SiteCode,k,n_nRef) %>% 
  rename(n_cong_10x10 = n_nRef)
df_SADsCongruentes <- inner_join(x=df_SADsCongruentes,
                                 y=df_resultados_antigos,
                                 by=c("SiteCode","k")) %>% 
  select(SiteCode,k,n_cong_10x10,n_cong_4x4)
# join
df_resultadosPiloto <- left_join(x=df_p,
                                 y=select(df_Umed,-U_var),
                                 by=c("SiteCode","k")) %>% 
  left_join(x=.,
            y=df_SADsCongruentes,
            by=c("SiteCode","k")) 
df_resultadosPiloto %>% str
write.csv(df_resultadosPiloto,
          file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultadosPiloto.csv",
          row.names = FALSE)
```

```{r Fig 5 graficos relacao diff Respostas e diff p, echo=FALSE,eval=TRUE,include=TRUE,fig.height=5,fig.width=10}
select <- dplyr::select
# dados
df_resultadosPiloto <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultadosPiloto.csv",
                                header = TRUE) %>% 
  mutate(diff_p = p_4x4-p_10x10,
         diff_Umed = U_med_4x4 - U_med_10x10,
         diff_SADs = n_cong_4x4 - n_cong_10x10)
df_dadosSites <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13] %>% 
  select(SiteCode, S_obs,Ntotal,DA) %>% distinct
df_resultadosPiloto <- left_join(x=df_resultadosPiloto,
                                 y=df_dadosSites,
                                 by="SiteCode")
# gráficos exploratórios  
v_labels <- c(diff_SADs="dif. #Congruentes", diff_Umed="dif. U")
l_p <- list()
l_p[[1]] <- df_resultadosPiloto %>% 
  select(SiteCode,k,diff_p:diff_SADs) %>% 
  pivot_longer(diff_Umed:diff_SADs,names_to = "respostas",values_to = "valores") %>% 
  ggplot(aes(x=diff_p,y=valores)) +
  geom_smooth(method = 'loess',formula = "y ~ x") +
  geom_point() + labs(x="dif. %CV",y="") +
  facet_wrap(~respostas,ncol=2,scale="free",labeller = labeller(respostas = v_labels))
v_labels <- c(S_obs="Riqueza", Ntotal="Indivíduos",DA="Densidade")
l_p[[2]] <- df_resultadosPiloto %>% 
  select(SiteCode,k,diff_p:DA) %>% 
  pivot_longer(S_obs:DA,names_to = "preditoras",values_to = "v_preditoras") %>% 
  ggplot(aes(x=v_preditoras,y=diff_SADs)) +
  geom_smooth(method = 'loess',formula = "y ~ x") +
  geom_point() + labs(x="",y="dif. #Congruentes") +
  facet_wrap(~preditoras,ncol=3,scale="free",labeller = labeller(preditoras = v_labels))
grid.arrange(grobs=l_p,
             ncol=1)
```
  
__Fig. 5__ Gráficos exploratórios da mudança nas variáveis respostas (eixo y) e da variável resposta proporção de cobertura vegetal (eixo x). A linha azul é feita pelo geom_smooth(method="sloess").    
  

## Resultados Atualizados
  
  
### Probabilidade de SAD predita ser congruente    
  
    
```{r  Fig 6 Comparacao predito modelo medio entre escalas, fig.height=5.5, fig.width=9,eval=TRUE,include=TRUE}
library(grid)
## predito pelo modelo médio para novo conjunto de dados
### 4x4 km2
load(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/mdAvg_nRefEE__AICcmodavg.Rdata")
mdAvg_nRefEE__AICcmodavg$SCALE <- "4x4"
df_ <- mdAvg_nRefEE__AICcmodavg
### 10x10 km2
load(file="~/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/mdAvg_nRefEE__AICcmodavg.Rdata")
mdAvg_nRefEE__AICcmodavg$SCALE <- "10x10"
df_plot <- rbind(df_,mdAvg_nRefEE__AICcmodavg)
df_plot %<>% 
  mutate(p = p.z * sd(df_resultados$p) + mean(df_resultados$p),
         d = d.z*sd(df_resultados$d) + mean(df_resultados$d))
############# 
## Gráficos
l_p <- list()
labels_IC <- c(lower.CL="quantile 5%", upper.CL="quantile 95%")
# labels_median <- c(EE="IC 5%", upper.CL="IC 95%")
v_breaks <- c(0.25,0.50,0.75)
### SENM Spatially-Explicit Neutral Model
df_plot_4x4 <- df_plot %>% filter(SCALE=="4x4") %>% mutate(label_ = "median")
l_p[[1]] <- ggplot(df_plot_4x4,aes(x=p,y=d,fill=mod.avg.pred)) +
  geom_tile() +
  # scale_fill_gradient2(limits = c(0,1),midpoint=0.5, high="#800000", low="#000080",mid="#7CFC00") +
  # scale_fill_continuous() +
  # scale_fill_gsea() +
  scale_fill_distiller(palette = "Spectral") +
  geom_contour(aes(z=mod.avg.pred),alpha=0.2, col="black",
               breaks = v_breaks) +
  labs(fill="",x="",y="") +
  coord_cartesian(expand = FALSE) +
  scale_y_continuous(breaks = seq(0,20,by=4)) +
  scale_x_continuous(breaks = seq(0.05,0.95,by=0.10)) +
  ggtitle("4x4 km2") +
  theme_classic() + facet_wrap(~label_, ncol=1) + 
  theme(legend.position = "bottom",
        plot.title = element_text(margin=margin(0,0,-1,-0),
                                  hjust = 0.5),
        plot.margin = unit(c(0.1,0.1,0.1,-0.5), "cm"))
v_legend <- get_legend(l_p[[1]])
l_p[[1]] <- l_p[[1]] + theme(legend.position="none")
df_plot_4x4 %<>% gather(key = IC_class ,value = IC_pred,lower.CL:upper.CL)
l_p[[2]] <- ggplot(df_plot_4x4,aes(x=p,y=d,fill=IC_pred)) +
  geom_tile() +
  # scale_fill_gradient2(limits = c(0,1),midpoint=0.5, high="red", low="blue",mid="black") +
  scale_fill_distiller(palette = "Spectral") +
  geom_contour(aes(z=IC_pred),alpha=0.2, col="black",
               breaks = v_breaks) +
  labs(fill="",x="",y="") +
  coord_cartesian(expand = FALSE) +
  scale_y_continuous(breaks = seq(0,20,by=4)) +
  scale_x_continuous(breaks = seq(0.10,0.90,by=0.20)) +
  theme_classic() + facet_wrap(~IC_class,ncol=2,labeller = labeller(IC_class = labels_IC)) + 
  theme(legend.position="none",
        plot.margin = unit(c(0.1,0.1,0.1,-0.5), "cm"))
a_4x4 <- plot_grid(l_p[[1]],NULL,l_p[[2]],ncol=1,rel_heights=c(2,-0.1,1.35))
# l_p[[3]] <- ggdraw() + draw_label("SENM")
# a_SENM <- plot_grid(l_p[[3]],NULL,a_SENM,ncol=1,rel_heights=c(0.1,-0.075,1))
### SINM Spatially-Explicit Neutral Model
df_plot_10x10 <- df_plot %>% filter(SCALE=="10x10") %>% mutate(label_ = "median")
l_p[[1]] <- ggplot(df_plot_10x10,aes(x=p,y=d,fill=mod.avg.pred)) +
  geom_tile() +
  # scale_fill_gradient2(limits = c(0,1),midpoint=0.5, high="red", low="blue",mid="black") +
  scale_fill_distiller(palette = "Spectral") +
  geom_contour(aes(z=mod.avg.pred),alpha=0.2, col="black",
               breaks = v_breaks) +
  coord_cartesian(expand = FALSE) +
  scale_y_continuous(breaks = seq(0,20,by=4)) +
  scale_x_continuous(breaks = seq(0.05,0.95,by=0.10)) +
  ggtitle("10x10 km2") +
  theme_classic() + facet_wrap(~label_, ncol=1) + 
  labs(fill="",x="",y="") +
  theme(legend.position = "none",
        plot.title = element_text(margin=margin(0,0,-1,0),
                                  hjust = 0.5),
        plot.margin = unit(c(0.1,0.1,0.1,-0.5), "cm"))
df_plot_10x10 %<>% gather(key = IC_class ,value = IC_pred,lower.CL:upper.CL)
l_p[[2]] <- ggplot(df_plot_10x10,aes(x=p,y=d,fill=IC_pred)) +
  geom_tile() +
  # scale_fill_gradient2(limits = c(0,1),midpoint=0.5, high="red", low="blue",mid="green") +
  scale_fill_distiller(palette = "Spectral") +
  geom_contour(aes(z=IC_pred),alpha=0.2, col="black",
               breaks = v_breaks) +
  labs(fill="",x="",y="") +
  coord_cartesian(expand = FALSE) +
  scale_y_continuous(breaks = seq(0,20,by=4)) +
  scale_x_continuous(breaks = seq(0.10,0.90,by=0.20)) +
  theme_classic() + facet_wrap(~IC_class,ncol=2,labeller = labeller(IC_class = labels_IC)) + 
  theme(legend.position="none",
        plot.margin = unit(c(0.1,0.1,0.1,-0.5), "cm"))
b_10x10 <- plot_grid(l_p[[1]],NULL,l_p[[2]],ncol=1,rel_heights=c(2,-0.1,1.35))
# l_p[[3]] <- ggdraw() + draw_label("SINM")
# b_SINM <- plot_grid(l_p[[3]],b_SINM,ncol=1,rel_heights=c(0.1, 1))
### Probability of not refuting a predicted SAD
l_p[[1]] <- ggdraw() + 
  draw_label("Prob. SAD predita ser Congruente",size=18,fontface ="bold") + 
  theme(plot.margin = unit(c(0,0,0,0), "lines"))
title <- plot_grid(l_p[[1]],NULL,v_legend,ncol=3,rel_widths = c(1,-0.39,0.50))
l_p[[2]] <- plot_grid(a_4x4,b_10x10,ncol=2,align = "hv")
#create common x and y labels
y.grob <- grid::textGrob("d", 
                   gp=gpar(fontface="bold"), rot=90)
x.grob <- grid::textGrob("p", 
                   gp=gpar(fontface="bold"))
l_p[[3]] <- plot_grid(y.grob,NULL,l_p[[2]],ncol=3,rel_widths = c(0.015,0,1))
l_p[[4]] <- plot_grid(l_p[[3]],NULL,x.grob,ncol=1,rel_heights = c(1,-0.04,0.04))
a_prob_of_not_refuting <- plot_grid(NULL,title,NULL,l_p[[4]],ncol=1,rel_heights = c(-0.08,0.25,-0.08,1))
a_prob_of_not_refuting
```
   
__Fig. 6__ Comparação predição pelo modelo médio. 


__Tabela 2__ Número de SADs congruentes: R2 marginal e condicional atualizado e antigo  
  
    
```{r tabela 2 R2 marginal e  condicional, eval=TRUE,include=TRUE}
library(lme4)
## R2 marginal e condicional
df_md <- df_resultados %>% filter(MN=="EE") %>% distinct()
l_md <- list()
l_md[[1]] <- glmer(cbind(n_nRef,100-n_nRef) ~ 
                      (p.z + I(p.z^2)) * (d.z + I(d.z^2)) + 
                      (d.z + I(d.z^2)|SiteCode),
                 family = "binomial",data=df_md,
                 control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e6)),
                 na.action = "na.fail")
l_md[[2]] <- glmer(cbind(n_nRef,100-n_nRef) ~ 
                      (p_10x10.z + I(p_10x10.z^2)) * (d.z + I(d.z^2)) + 
                      (d.z + I(d.z^2)|SiteCode),
                 family = "binomial",data=df_md,
                 control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e6)),
                 na.action = "na.fail")
# GLMM <- l_md[[2]]
f_R2_GLMM <- function(GLMM){
  df_ <- as.data.frame(MuMIn::r.squaredGLMM(GLMM))
  (df_ %>% 
      mutate(method=c("theoretical","delta"),
             across(1:2,round, 4)))
}
names(l_md) <- c("4x4","10x10")
df_R2 <- ldply(l_md,f_R2_GLMM) %>% 
  rename(landscape=".id")
df_R2
```


### U Estimado  
  

```{r Fig 7 GAMM U predito, fig.height=6,fig.width=13.5,eval=TRUE,include=TRUE}
library(metR)
# dados
df_plot <- read.csv("~/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_plot_U.Rdata",
                      header = TRUE,as.is = TRUE)
## graficos
l_p <- list()
# 
df_plot$IC_pred <- "5% quantile"
l_p[[1]] <- ggplot(df_plot,aes(x=p,y=d,fill=lower)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~IC_pred,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=lower),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$lower,probs = c(0.1,0.25,0.5,0.75,0.9)),5)) +
  geom_text_contour(aes(z=lower),stroke=0.2,
                    breaks = round(quantile(df_plot$lower,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=2.7)
#
df_plot$variable <- "median"
l_p[[2]] <- ggplot(df_plot,aes(x=p,y=d,fill=fit)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~variable,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=fit),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$fit,probs = c(0.1,0.25,0.5,0.75,0.9)),5) ) +
  geom_text_contour(aes(z=fit),stroke=0.2,
                    breaks = round(quantile(df_plot$fit,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=3)
#
df_plot$IC_pred <- "95% quantile"
l_p[[3]] <- ggplot(df_plot,aes(x=p,y=d,fill=upper)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~IC_pred,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=upper),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$upper,probs = c(0.1,0.25,0.5,0.75,0.9)),5)) +
  geom_text_contour(aes(z=upper),stroke=0.2,
                    breaks = round(quantile(df_plot$upper,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=2.7)
grid.arrange(grobs=l_p,ncol=3,top="4x4 km2")
```



```{r Fig 7 GAMM U predito 10x10km2, fig.height=6,fig.width=13.5,eval=TRUE,include=TRUE}
# dados
df_plot <- read.csv("~/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_plot_U.Rdata",
                      header = TRUE,as.is = TRUE)
## graficos
l_p <- list()
# 
df_plot$IC_pred <- "5% quantile"
l_p[[1]] <- ggplot(df_plot,aes(x=p,y=d,fill=lower)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~IC_pred,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=lower),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$lower,probs = c(0.1,0.25,0.5,0.75,0.9)),5)) +
  geom_text_contour(aes(z=lower),stroke=0.2,
                    breaks = round(quantile(df_plot$lower,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=2.7)
#
df_plot$variable <- "median"
l_p[[2]] <- ggplot(df_plot,aes(x=p,y=d,fill=fit)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~variable,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=fit),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$fit,probs = c(0.1,0.25,0.5,0.75,0.9)),5) ) +
  geom_text_contour(aes(z=fit),stroke=0.2,
                    breaks = round(quantile(df_plot$fit,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=3)
#
df_plot$IC_pred <- "95% quantile"
l_p[[3]] <- ggplot(df_plot,aes(x=p,y=d,fill=upper)) +
  coord_cartesian(expand = FALSE) + 
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_classic() + 
  facet_wrap(~IC_pred,ncol=1) +
  theme(legend.position="bottom",legend.title = element_blank()) +
  geom_contour(aes(z=upper),alpha=0.4, col="black",
               breaks = round(quantile(df_plot$upper,probs = c(0.1,0.25,0.5,0.75,0.9)),5)) +
  geom_text_contour(aes(z=upper),stroke=0.2,
                    breaks = round(quantile(df_plot$upper,probs = c(0.1,0.25,0.5,0.75,0.9)),5),
                    rotate = FALSE,
                    size=2.7)
grid.arrange(grobs=l_p,ncol=3,top="10x10 km2")
```
  
__Fig. 7__ Predito pelo modelo estatístico para o U estimado nas paisagens atuais (4x4 km2) e anteriores (10x10 km2).  
  
  
  
# Material Suplementar

<!-- #### Código para recorte das paisagens -->

```{r recorte das paisagens para piloto remover?,echo=FALSE}
df_sims <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/df_simulacao.csv",
                    header = TRUE) %>% 
  select(!(U_med:theta)) %>% filter(k==0.05)
# names(df_sims)[10:11] <- paste0(names(df_sims)[10:11],"_10x10")
# estudo funcao
# file_path <- df_sims$txt.name[3]
f_recorte <- function(file_path){
  mat_paisagem <- read.table(file=file_path,sep=" ",header=TRUE) %>% 
    as.matrix
  v_dim_novo <- dim(mat_paisagem) - round(dim(mat_paisagem) * (4.14/10.2),0)
  v_dim <- dim(mat_paisagem)
  mat_paisagem_output <- mat_paisagem[floor(v_dim_novo[1]/2):(v_dim[1]-1-ceiling(v_dim_novo[1]/2)),
                                      floor(v_dim_novo[2]/2):(v_dim[2]-1-ceiling(v_dim_novo[2]/2))]
  write.table(mat_paisagem_output,
              file=gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        file_path),
              sep=" ", 
              row.names = FALSE,col.names = FALSE)
  tree.cover <- as.vector(mat_paisagem_output)
  p <- 1 - length(tree.cover[tree.cover==0])/length(tree.cover)
  return(p)
}
# image(mat_paisagem)
df_sims$p_4x4 <- aaply(df_sims$txt.name,1,f_recorte)
# df_sims %>%
#   ggplot(aes(x=p,y=p_4x4)) +
#   geom_abline(slope = 1,intercept = 0,color="red",alpha=0.6) +
#   geom_point()
###
df_sims %>% 
  select(SiteCode, p_4x4, p) %>% 
  rename(p_10x10 = p) %>% 
  write.csv(x=.,
            file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
            row.names = FALSE)
# plotar todos os paineis
df_sims %>% 
  mutate(txt.name_antigo = txt.name,
         txt.name = gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        txt.name_antigo))
write.csv(df_sims,
          file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
          row.names=FALSE)
# "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/"
```

<!-- #### Recortes das paisagens de 10x10km para 4x4km -->
  
<!-- - Códigos Estimativa de U   -->

```{r simulacao U, echo=FALSE,eval=FALSE,include=FALSE}
# replicas
n_rep.U <- 10
func1 <- function(x,replicas=n_rep.U) {
  x$U <- NA
  x <- x[rep(1:dim(x)[1],each=replicas),]
}
# nomes
df_simulacao.U <- df_sims %>% func1()
####################
# simulacao
## objetos necessarios
# system(paste0("mkdir ",getwd(),"/U")) # pasta para armazenar os data.frames, só faz uma vez
k_factor <- unique(df_simulacao.U$k) # dividi as simulações por blocos de cenário de limitação
registerDoMC(3)
for(a in 1:length(k_factor)){
  df_simU <- df_simulacao.U %>% dplyr::filter(k == k_factor[a])
  op <- options(digits.secs=6)
  funcao_imigracao <- function(i,df_temp=df_simU){
    aviao <- list()
    aviao <- dinamica_coalescente(U = 1.25e-06,
                                  S = df_temp[i,"S_obs"],
                                  N_simul = 1,
                                  seed = as.numeric(Sys.time()),
                                  disp_range = df_temp[i,"d"],
                                  disp_kernel = df_temp[i,"kernel_code"],
                                  landscape = df_temp[i,"txt.name"])
    return(aviao$U_est)
  }
  replica.sim <- as.list(1:dim(df_simU)[1])
  sim.coal_U <- llply(.data = replica.sim, .fun = funcao_imigracao, .parallel = TRUE)
  df_simU[,"U"] <- unlist(sim.coal_U)
  write.csv(df_simU,
            file=paste0("./U/","df_simU__k",k_factor[a],".csv"),row.names = FALSE)
}
```

<!-- A simulação ocorreu entre 19h58 e 21h11, totalizando 1h13. Se considerarmos 103 sítios, serão 5h45. Pras SADS eu estimo que seja fique 54h49, 2.27 dias. -->

<!-- - Códigos SADs preditas -->

```{r simulacao SADs MNEE, echo=FALSE,eval=FALSE,include=FALSE}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_simulacao <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k"))
# system(paste0("mkdir ",getwd(),"/SADs_preditas")) # pasta para armazenar os data.frames, só faz uma vez
n_rep.SAD <- 100
f_simulacao <- function(i,df_=df_simulacao){
  X <- df_[i,] %>% as.data.frame()
  mat_sim <- dinamica_coalescente(U = X[,"U_med"],
                                  S = 0,
                                  N_simul = n_rep.SAD,
                                  seed = as.numeric(Sys.time()),
                                  disp_range = X[,"d"],
                                  disp_kernel = X[,"kernel_code"],
                                  landscape = X[,"txt.name"])
  df_SAD.replica <- bind_rows(alply(mat_sim,1,function(Y) data.frame(N = sort(as.integer(table(Y))) ) ),
                              .id = "replica")
  df_SAD.replica %<>% 
    mutate(SiteCode = X$SiteCode, MN = "EE", k = X$k)
  path.file <- paste0("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/",
                      X[,"SiteCode"],
                      "_k",X[,"k"],
                      "_EE.csv")
  write.csv(df_SAD.replica,
            file = path.file,
            row.names = FALSE)
}
registerDoMC(3)
simulacao <- as.list(1:dim(df_simulacao)[1])
l_ply(simulacao,f_simulacao,.parallel = TRUE)
```

<!-- As simulações das SADs ocorreram entre 23h10 e 00h30 -->

<!-- - Códigos teste KS -->

```{r dados para teste KS,echo=FALSE,eval=FALSE,include=FALSE}
### dados e preparação
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/U/*.csv"), read_csv)
df_Umed <- df_U %>% 
  ddply(.variables = c("SiteCode","k"),summarise,
        U_med = mean(U),
        U_var = var(U))
df_sims <- read.csv(file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
                    header = TRUE)
df_resultados <- left_join(x=df_sims,y=df_Umed,by=c("SiteCode","k")) %>% 
  mutate(diff_Umed = U_med - U_med_10x10)
## SAD obs
df_SAD.obs <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/dados_para_iniciar_artigo/abundances.csv",
                       header = TRUE,as.is = TRUE)
df_SAD.obs %<>% filter(SiteCode %in% unique(df_resultados$SiteCode))
# f_write <- function(df_){
#   df_tWrite <- df_[,c("SiteCode","species.correct","N")]
#   path_ <- paste0("/home/danilo/Documentos/Doutorado/artigo_mestrado/1A.P_MOVER/simulacao/SAD_observada/SADobs_",
#                   df_tWrite$SiteCode[1],".csv")
#   write.csv(df_tWrite,path_,row.names = FALSE)
# }
# registerDoMC(3)
# d_ply(df_SAD.obs,"SiteCode",f_write,.parallel = TRUE)
df_SAD.obs %<>% group_by(SiteCode) %>% nest %>% rename(SAD_obs=data)
## SAD replica
df_SADreplica <- Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/*.csv") %>% 
  gsub("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/|.csv|_EE","",.) %>% 
  adply(.,1,function(x) unname( unlist( strsplit(x,"_k",fixed = TRUE))),.id = NULL) %>% 
  rename(SiteCode = V1,k = V2)
df_SADreplica$file_path <- Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/SADs_preditas/*.csv")
df_SADreplica %<>% group_by(SiteCode) %>% nest %>% rename(SAD_MN=data)
## merge
df_SADs <- inner_join(y=df_SADreplica,
                      x=df_SAD.obs,
                      by="SiteCode")

### rotina de testes
df_SADs$resultados <- vector("list",length = nrow(df_SADs))
registerDoMC(3)
for(i in 1:nrow(df_SADs)){
  X <- df_SADs[i,]
  v_SADobs <- X$SAD_obs[[1]]$N
  # v_MN <- df_SADs$SAD_MN[1]
  f_KS <- function(v_obs=v_SADobs,v_MN,boots=200){
    testeKS <- ks_test(a=v_obs,b = v_MN, nboots = boots)
    a <- data.frame(D_KSboot=testeKS[1],p.valor_KSboot=testeKS[2])
    a$S_SAD.predita <- length(v_MN)
    a$S_SAD.obs <- length(v_obs)
    return(a)
  }
  df_predicao <- X$SAD_MN[[1]] %>% as.data.frame()
  f_resultados <- function(path_df,parallel_=FALSE){
    # path_df <- df_predicao$file_path[1]
    df_SAD.MN <- read.csv(path_df,header = TRUE,as.is = TRUE)
    df_return <- ddply(df_SAD.MN,"replica",function(Y) f_KS(v_MN=Y$N),.parallel = parallel_)
    df_return %<>% mutate(SiteCode = df_SAD.MN$SiteCode[1], 
                          MN = df_SAD.MN$MN[1], 
                          k = df_SAD.MN$k[1])
    return(df_return)
  }
  df_SADs$resultados[[i]] <- adply(df_predicao,1,
                                   function(line) f_resultados(path_df = line$file_path),.parallel = TRUE)
}
for(i in 1:nrow(df_SADs)){
  df_SADs$resultados[[i]]$replica <- as.character(df_SADs$resultados[[i]]$replica)
}
df_replicas <- df_SADs %>% rename(Site = SiteCode) %>% 
  select(resultados) %>% unnest(cols=c(resultados)) %>% as.data.frame() %>% 
  select(SiteCode,MN,k,replica,D_KSboot,p.valor_KSboot,S_SAD.predita,S_SAD.obs)
write.csv(df_replicas,
          file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_replicas.csv",
          row.names = FALSE)
```

```{r summarise replicas teste KS,echo=FALSE,eval=FALSE,include=FALSE}
# dados
df_replicas <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_replicas.csv",
                        header = TRUE,as.is = TRUE)
df_replicas %<>% mutate(diff_S = (S_SAD.predita - S_SAD.obs)/S_SAD.obs)
# sumarização
alpha <- 0.05
f_maxRank <- function(obs,predito){
  max_rank <- max(c(obs,predito))
  return(max_rank)
}
registerDoMC(3)
df_resultados <- ddply(df_replicas,c("MN","k","SiteCode"),summarise,
                       # D_mean = mean(D_KSboot), D_var = var(D_KSboot),
                       # p.value_mean = mean(p.valor_KSboot),p.value_var = var(p.valor_KSboot),
                       # S.MN_mean = mean(S_SAD.predita), S.MN_var = var(S_SAD.predita),
                       S.obs_mean = mean(S_SAD.obs),
                       # S.obs_var = var(S_SAD.obs),
                       diffS_mean = mean(diff_S),diffS_var = var(diff_S),
                       n_nRef = sum(p.valor_KSboot>=alpha), n_Ref = sum(p.valor_KSboot<alpha),
                       # max_rank = f_maxRank(obs=S_SAD.obs,predito=S_SAD.predita),
                       .parallel = TRUE)
write.csv(df_resultados,
          "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_resultados.csv",
          row.names = FALSE)
```

<!-- - EXTRA: Ap Final BIE 5770 -->

<!-- Gráficos usados na apresentação final de BIE 5770: ano da amostragem das SADs e ano referência do mapa de cobertura vegetal. -->

```{r gráficos,include=FALSE,eval=FALSE,echo=FALSE}
#
df_SADs.disponiveis <- read.csv(
  "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/dados_para_iniciar_artigo/df_SADs_disponiveis.csv",
  header =T)
df_SADs.disponiveis %<>% 
  filter(method=="parcelas" &
           grepl("*contiguous*",arrangement) & 
           effort_ha>=1 &
           grepl("*yes*",status) & 
           grepl("ok*",status_diagnostico) &
           grepl("Atlantic_Forest*",domain) &
           dbh_cutoff %in% c("PBH>=15.0cm","PBH>=15.7cm",
                             "DBH>=5.0cm","DGH>=5.0cm","DBH>5.0cm",
                             "DBH>=4.8cm",
                             "DBH>=5.0cm&H>300cm","DBH>=5.0cm&H>500cm", 
                             "DGH30>=5.0cm")
         )
# df_SADs.disponiveis %>%
#   select(status_diagnostico:effort_ha) %>% 
#   select(-c(state,samples))


## dados disponíveis: usando landsat8 (ano referência 2000)
df_S1 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/tabelaSI1.csv",
                  header = TRUE) %>% 
  mutate(year_plot = ifelse(is.na(year_data),year,year_data))
df_S1$year_plot[df_S1$year_plot=="2012_2013"] <- "2012.5"
df_S1$year_plot <- as.numeric(df_S1$year_plot)
### Filtros usados
### filtro universidades e campi
# df_filtro.UC <- df_1ofiltro %>% 
#   filter(UC_area_ha >= 1000 | 
#          Unidade_de_conservacao %in% c("UC Protecao Integral","universities and research centers"))
# ### filtro estados
# df_filtro.estate <- filter(df_1ofiltro,state %in% c("RJ","RS") & year >= 1990)
# df_filtro.estate %<>% rbind(.,filter(df_1ofiltro,state %in% c("BA","GO","MS") & year >= 2000))
# df_filtro.estate %<>% rbind(.,filter(df_1ofiltro,!(state %in% c("BA","GO","MS","RJ","RS")) & year >= 1995))
df_S1$site_category <- NA
df_S1$site_category[df_S1$UC_area_ha>=1000 | 
                      df_S1$Unidade_de_conservacao %in% 
                      c("UC Protecao Integral","universities and research centers")] <- 1
df_S1$site_category[df_S1$state %in% c("RJ","RS") & 
                      df_S1$year >= 1990] <- 2
df_S1$site_category[df_S1$state %in% c("BA","GO","MS") & 
                      df_S1$year >= 2000] <- 3
df_S1$site_category[!(df_S1$state %in% c("BA","GO","MS","RJ","RS")) & 
                      df_S1$year >= 1995] <- 4
df_S1 %>%
  mutate(site_category = factor(site_category)) %>% 
  ggplot(aes(x=year_plot,y=site_category,shape=site_category)) +
  # geom_vline(xintercept = 2000,color="red") + # versão 1
  geom_vline(aes(xintercept = year_plot),color="red",alpha=0.3) + # versão 2
  # geom_boxplot() +
  geom_jitter() +
  labs(shape="Categorias:",
       y="categoria inventário florestal",
       x="ano inventário florestal",
       title= "104 inventários dentro dos critérios (de 109 confiáveis)") +
  scale_shape_discrete(breaks=c("1","2","3","4"),
                       labels=c("todas as idades: \nUC Prot. Int. | Univ. | UC>=1000 ha",
                                "RJ e RS >= 1990",
                                "BA, GO e MS >= 2000",
                                "outros estados Brasil >= 1995")) +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
# df_S1 %>% arrange(year_plot) %>% select(year_plot,UC_area_ha,state)
```

```{r df_S2 ,include=FALSE,eval=FALSE,echo=FALSE}
df_S2 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/tabelaSI2.csv",
                  header = TRUE) %>% 
  mutate(year_plot = ifelse(is.na(year_data),year,year_data))
df_S2$year_plot[df_S2$year_plot=="2012_2013"] <- "2012.5"
df_S2$year_plot <- as.numeric(df_S2$year_plot)
df_S2$site_category <- "1"
df_S2 %>%
  mutate(site_category = factor(site_category)) %>% 
  ggplot(aes(x=year_plot,y=site_category,shape=site_category)) +
  geom_vline(aes(xintercept = year_plot),color="red",alpha=0.6) + # versão 2
  # geom_boxplot() +
  geom_jitter() +
  labs(shape="",
       y="",
       x="ano inventário florestal",
       title= "109 inventários com SAD e coordenada confiáveis") +
  scale_shape_discrete(breaks="") +
                       # labels="- Atlantic Forest \n- DBH >= 5.0cm \n- plot >= 1ha") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

 <!-- Escala de Efeito -->

```{r selecao da escala espacial, echo=FALSE, include=FALSE, eval=FALSE}
df_se <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/resultados_e_SI/df_escalaEfeito.csv",header = T)
# ajuste de modelos aos dados
library(MASS)
f_glm.nb <- function(data_){
  md_ <- glm.nb(S_obs ~ p + I(p^2) + offset(log(Ntotal)), data = data_)
}
registerDoMC(3)
l_md <- dlply(df_se,"raio_km",f_glm.nb,.parallel = TRUE)
# média ponderada dos raios pelo peso de evidência
df_averageSE <- print(AICctab(l_md,weights=TRUE)) %>% 
  as.data.frame()
df_averageSE$raio_paisagem <- row.names(df_averageSE) %>% as.numeric()
df_averageSE$weight <- as.numeric(as.character(df_averageSE$weight))
df_averageSE$dAICc <- as.numeric(as.character(df_averageSE$dAICc))
# (raio_medio <- round(weighted.mean(x = df_averageSE$raio_paisagem,w = df_averageSE$weight),1))  
raio_medio <- mean(df_averageSE %>% filter(dAICc==0) %>% .$raio_paisagem)
df_averageSE %>% 
  # mutate(diff_moda = max(df_averageSE$weight) - weight) %>% 
  # filter(diff_moda < 0.0005) %>% dim
  ggplot(aes(x=raio_paisagem,y=weight)) +
  geom_line() + 
  geom_vline(xintercept = raio_medio,color="red",alpha=0.5) + 
  annotate(geom="text",x=raio_medio+1.3,y=0.002,label=paste0("raio médio = ",raio_medio," km"),size=3) +
  theme_classic()
```

<!-- O raio médio = `r raio_medio` (2.07) e portanto o lado da paisagem é de `r 2*raio_medio`km e área total de 1713.96 hectares   -->
  
<!-- O lado anterior é de 10.2x10.2, o lado atual é 4.14x4.14. -->

     
       
### Códigos do sorteio de sítios ao longo do gradiente de cobertura vegetal nas paisagens de 10x10km2      
    
```{r dados,message=FALSE,echo=FALSE,eval=FALSE,include=FALSE}
### dados ###
# leitura
df_resultados <- read.csv(file="/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/resultados/df_resultados.csv",
                            header = TRUE,as.is=FALSE)[,1:13]
# padronização
level_k <- as.character(unique(sort(as.numeric(df_resultados$k),decreasing = TRUE)))
df_resultados$k <- factor(df_resultados$k,levels = level_k)
levels(df_resultados$k)[19] <- "0.1"
# z score
f_z <- function(x){
  m <- base::mean(x,na.rm=FALSE)
  sd <- sd(x,na.rm=FALSE)
  output <- (x-m)/sd
  return(output)
} 
# names(df_resultados)
# str(df_resultados)
df_resultados %<>% mutate(diffS_gamma = diffS_mean + min(diffS_mean)*(-1) + 0.01,
                          modulo_diffS = abs(diffS_mean),
                          log_Sobs=log(S_obs))

df_resultados.z <- as.data.frame(apply(df_resultados[,c("p","Ntotal","log_Sobs","k_1","d_Lplot","d","modulo_diffS")],2,f_z))
names(df_resultados.z) <- sapply(names(df_resultados.z), function(x) paste0(x,".z"))
df_resultados %<>% cbind(.,df_resultados.z) %>% 
  select(-k_1,-k_1.z)
```

```{r sorteio de pontos para o piloto,echo=TRUE,eval=FALSE}
f_random_byVar <- function(x = df_resultados,
                           column_name = "p", 
                           n_sample = 30, 
                           i_seed = 260320223){
  # amostra de uma uniforme
  set.seed(i_seed)
  sample_points <- sort(runif(n = n_sample, min = 0, max = 1))
  # encontra os valores mais próoximos
  df_x <- filter(x,k==levels(x$k)[1],MN=="EE")
  f_index <- function(X=df_x,
                      name=column_name,
                      v_ref){
    which.min(abs(X[[column_name]] - v_ref))
  }
  # remove os sítios repetidos
  v_sites <- df_x[sapply(sample_points,function(y) f_index(v_ref=y)),"SiteCode"] %>% unique
  ## output:
  df_return <- filter(x,SiteCode %in% v_sites,MN=="EE")
  df_return$SiteCode <- factor(df_return$SiteCode)
  return(df_return)
}
df_piloto <- f_random_byVar(x=df_resultados)
write.csv(df_piloto,file = "./artigo_mestrado/1A.P_MOVER/Support Information/df_piloto.csv",
          row.names = FALSE)
```


```{r graficos df_piloto,echo=FALSE,eval=FALSE,include=FALSE}
df_piloto <- read.csv(file="df_piloto.csv", header = TRUE)
# gráficos exploratóritos
df_piloto %>% 
  filter(k==unique(df_piloto$k)[1]) %>% 
  ggplot(aes(x=p,y=S_obs)) + 
  geom_point() +
  ggtitle(label="Sítios Sorteados") +
  labs(x="% Tree cover (p)",y="Species Richness")
```
  
### Códigos para recorte das paisagens  
  
```{r recorte das paisagens para piloto,echo=TRUE,eval=FALSE}
f_recorte <- function(file_path){
  # matriz da paisagem de 10x10km:
  mat_paisagem <- read.table(file=file_path, 
                             sep=" ",
                             header=TRUE) %>% 
    as.matrix
  #redução proporcional no número de linhas e colunas da matriz:
  v_dim_novo <- dim(mat_paisagem) - round(dim(mat_paisagem) * (4.14/10.2),0)
  v_dim <- dim(mat_paisagem)
  # recorte:
  mat_paisagem_output <- mat_paisagem[floor(v_dim_novo[1]/2):(v_dim[1]-1-ceiling(v_dim_novo[1]/2)),
                                      floor(v_dim_novo[2]/2):(v_dim[2]-1-ceiling(v_dim_novo[2]/2))]
  ## outputs:
  # salva a nova paisagem
  write.table(mat_paisagem_output, 
              file=gsub("dados_para_iniciar_artigo",
                        "piloto_MNEE_4x4km",
                        file_path),
              sep=" ", 
              row.names = FALSE,col.names = FALSE)
  tree.cover <- as.vector(mat_paisagem_output)
  p <- 1 - length(tree.cover[tree.cover==0])/length(tree.cover)
  # e retorna a atual proporção de cobertura vegetal
  return(p) 
}
registerDoMC(3)
p_4x4 <- aaply(df_$txt.name,1,f_recorte,.parallel = TRUE)
```
  
