---
title: "MNEI de Hu et al. 2007"
author: "Danilo Pereira Mori"
date: '2022-06-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE,message = FALSE, warning = FALSE,cache=TRUE)
```

```{r pacotes,echo=FALSE,warning=FALSE,message=FALSE}
library(magrittr)
`library(jpeg)
library(doMC)
library(tidyverse)
library(cowplot)
library(plyr)
library(dplyr)
```
</br>

Referência Base:
Hu, X. S., He, F., & Hubbell, S. P. (2007). Species diversity in local neutral communities. American Naturalist, 170(6), 844–853. https://doi.org/10.1086/522935

<!-- </br> -->

<!-- # Contexto -->

<!-- </br> -->

```{r dados simulados,echo=FALSE,warning=FALSE,message=FALSE, eval=FALSE}
df_U <- map_df(Sys.glob("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/simulacao_codigos_e_resultados/U/*.csv"), read_csv)
df_simulacao <-  inner_join(x=distinct(dplyr::select(df_U, SiteCode, k, Ntotal, S_obs, kernel_code, DA, d, p, txt.name)),
                            y=ddply(df_U,c("SiteCode","k"),summarise,U_med = mean(U), U_var = var(U)),
                            by=c("SiteCode","k"))
df_p_4_10 <- read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/piloto_MNEE_4x4km/resultados/df_p_4x4_10x10.csv",
                       header = TRUE) %>% 
  dplyr::select(-p_10x10)
df_resultados <- left_join(x=df_simulacao,
                           y=df_p_4_10,
                           by="SiteCode") %>% 
  select(-p,-kernel_code,-txt.name) |>
  select(SiteCode,p_4x4,k:U_med) |> 
  dplyr::rename(p=p_4x4)
write_csv(df_resultados,
          file = "/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_dados_Hu2007.csv")
```
```{r conversão de parâmetros,echo=FALSE,eval=FALSE}
df_resultados <- read_csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/Support Information/df_dados_Hu2007.csv")
df_resultados %<>% 
  mutate(J_M = 1713.96 * DA * p, # 4.14x4.14  km2 = 1713.96 ha
         L = sqrt( 10000 * (Ntotal/DA) ),
         m = ((d^2)/(L^2)) *(L*sqrt(2)/d - 1/2 + (1-L * sqrt(2)/d) * exp(-L*sqrt(2)/d) - exp(-2*sqrt(2)*L/d)/2), # eq 8, Contas de Coutinho
         m_ = m * p / ( 1 - (1-p)*m ),#eq 5
         ratio_J_JM = Ntotal/J_M)
```
```{r figura 1 U e m,fig.width=10,fig.height=4,echo=FALSE,warning=FALSE,message=FALSE,eval=FALSE}
l_p <- list()
l_p[[1]] <- df_resultados |> 
  ggplot(aes(x=m_,y=U_med)) +
  geom_bin2d(bins=70) +
  scale_fill_continuous(type = "viridis") +
  geom_abline(slope = 1,intercept = 0,color="red",alpha=0.6,size=1) +
  coord_cartesian(expand = FALSE) +
  labs(x="probabilidade m corrigida por p",y="taxa U",title="Em alguns casos U > m e na maioria U não é << m") +
  theme_classic()
l_p[[2]] <- df_resultados |> 
  ggplot(aes(x=m_,y=U_med)) +
  geom_bin2d(bins=70) +
  scale_fill_continuous(type = "viridis") +
  geom_abline(slope = 1,intercept = 0,color="red",alpha=0.6,size=1) +
  coord_cartesian(expand = FALSE) +
  scale_y_continuous(trans="log10") +
  scale_x_continuous(trans="log10") +
  labs(x="probabilidade m corrigida por p",y="taxa U",title="log10 x log10") +
  theme_classic()
gridExtra::grid.arrange(grobs=l_p,ncol=2)
```

<!-- </br> -->

<!-- __Figura 1__  Probabilidade média de surgimento de um indivíduo de uma nova espécie na paisagem (U) e a probabilidade média de uma colonização na comunidade local ser de um propágulo vindo da paisagem ao redor (m), corrigida pela proporção de cobertura vegetal na paisagem (p).   -->

<!-- </br>     -->

<!-- Anteriormente aproximamos MNEI pela fórmula de amostragem de Etienne (2005). Nesse modelo, e na maior parte dos modelos neutros espacialmente implícitos, se assume que U << m e, portanto, é possível negligenciar U na comunidade local. Em nosso caso, que estamos interpretando MNEI como uma simplificação de MNEE e usamos o último para estimar o parâmetro U para um dado cenário de limitação de dispersão, não encontramos situações em que é razoável pressupor U << m (Figura 1). Acredito que iniciamos a investigação com a fórmula de amostragem pois ela já tinha sido comparada anteriormente com MNEE (Etienne & Rosindell 2011), mesmo MNEE pressupondo U local. Apesar de não se considerar U local, os modelos espacialmente implícitos podem decompor m no componente de espécies locais daquele de novas espécies (species input, Condit et al. 2012). Ambos parâmetros da fórmula de amostragem (theta e (I ou m?)) são correlacionados simultaneamente com o desvio-padrão da função de dispersão e com U de MNEE (Etienne & Rosindell 2011). Assim uma primeira aproximação que pensamos em fazer foi o de usar a fórmula de amostragem somando no parâmetro m a taxa U, inflando o species input, para aproveitar pacotes existentes do R (e.g. untb).    -->

<!-- </br> -->

<!-- Posteriormente encontramos o artigo de Hu et al (2007) onde eles criam um MNEI em que há U localmente e exploram o limite em que J -> J_M. Nós exploramos em algum grau esse limite ao investigar paisagens com perda de cobertura vegetal, porém, mesmo nas paisagens com perda de cobertura vegetal mais severa (~5% de cobertura remanescente) a área da parcela corresponde à menos de 1% da área total de cobertura vegetal, se mantendo distante da situação limite que Hu et al. 2007 exploram de J/J_M = 1. Assim, escolhemos implementar MNEI de Hu et al. (2007) pela possibilidade de incluir U localmente. Na situação limite de m->U, a SAD predita pela fórmula de amostragem (Etienne 2005) deve tender para uma lognormal (Magurran 2003); em MNEI de Hu et al. (2007), na ausência de propágulos vindos da paisagem ao redor é possível modelar a SAD local como de uma metacomunidade de tamanho J, se aproximando de uma SAD com duas modas: raras e abundantes (fig. 3, Hu et al. 2007).  -->

<!-- </br> -->

<!-- ### Perguntas -->

<!-- -   A chance de U é maior do que a chance de m em paisagens com baixa proporção de cobertura vegetal?   -->
<!-- -   No campo de parâmetros investigado, há diferença na SAD predita pela fórmula de amostragem (Etienne 2005) e MNEI de Hu et al. (2007)?   -->

<!-- # Descrição do LogOR(U/m) -->



<!-- # MNEI -->

## Hu et al. 2007  

<!-- __Eq. 5:__ -->

```{r equacao 5 de Hu et al 2007, echo=FALSE,eval=FALSE}
# .JM <- 10^6
# .JL <- 10^4
# .U <- 10^(-5)
# .m <- 10^(-6)
# .x <- 1/.JL
# Q <- 1/.J_M
###### código do PI adaptado do SI de Hu et al. 2007
# equação 5
f_eq5_HUetal2007 <- function(.U,.m,.JL,.JM){
  f_abundance <- function(x, speciation, migration_rate, JL, JM){
    small_theta <- 2*JL*speciation
    capital_theta <- 2*JM*speciation
    migrants <- JL*migration_rate
    f1 <- function(y) (1-y)^(capital_theta-1)/y
    .C <- 1/integrate(f1,1/JM, 1)$value
    c1 <- function(Q){
      lc1 <- lgamma(2*migrants+small_theta+1) -
        (lgamma(2*migrants*(1-Q)+small_theta) + lgamma(2*migrants*Q+1))
      exp(lc1)
    }
    f2 <- function(Q)
      c1(Q)*(1-x)^(2*migrants*(1-Q)+small_theta-1)*x^(2*migrants*Q-1)*(1-Q)^(capital_theta-1)/Q
    .C*integrate(f2, 1/JM, 1)$value
  }
  r.abund <- seq(0.01,0.99, by=0.01) #seq(1/.JL,0.99, by=1/.JL)
  phi.x <- sapply(r.abund, f_abundance , speciation = .U, migration_rate = .m, JL = .JL, JM=.JM)
  df_ <- data.frame(x=r.abund,phi_x=phi.x)
  return(df_)
}
######
# equação 4
f_eq4_HUetal2007 <- function(.x,.U,.m,.JL,.JM){
  f_abundance <- function(x, speciation, migration_rate, JL, JM){
    small_theta <- 2*JL*speciation
    capital_theta <- 2*JM*speciation
    migrants <- JL*migration_rate
    f1 <- function(y) (1-y)^(capital_theta-1)/y
    .C <- 1/integrate(f1,1/JM, 1)$value
    f_Qbarra <- function(Q) (1-Q)^(capital_theta-1)
    Qbarra <- .C * integrate(f_Qbarra,1/JM, 1)$value
    c1 <- function(Q){
      lc1 <- lgamma(2*migrants+small_theta+1) -
        (lgamma(2*migrants*(1-Q)+small_theta) + lgamma(2*migrants*Q+1))
      exp(lc1)
    }
    f2 <- function(Q) c1(Q)*(1-x)^(2*migrants*(1-Q)+small_theta-1)*x^(2*migrants*Q-1)
    f2(Qbarra)
  }
  phi_x <- f_abundance(x=.x)
  r.abund <- seq(0.01,0.99, by=0.01) #seq(1/.JL,0.99, by=1/.JL)
  phi.x <- sapply(r.abund, f_abundance , speciation = .U, migration_rate = .m, JL = .JL, JM=.JM)
  df_ <- data.frame(x=r.abund,phi_x=phi.x)
  return(df_)
}
df_ |> 
  ggplot(aes(x=x,y=phi_x)) +
  geom_line()
```
```{r dados para figura 3 de Hu et al 2007, echo=FALSE,eval=TRUE}
# dados usados na figura 3
df_fig3_HUetal2007 <- data.frame(U=10^(-5),J=10^4,JM=10^6,m=10^(-6:-3)) |> 
  mutate(lambda=factor(J*m))
# f_rep <- function(x,n_rep=100) {
  # x <- x[rep(1:dim(x)[1],each=n_rep),]
  # x$rep <- rep(1:n_rep,4)
  # row.names(x) <- NULL
  # return(x)
# }
registerDoMC(2)
df_plot  <- ddply(df_fig3_HUetal2007,
                  "lambda",
                  function(X) f_eq5_HUetal2007(.JM = X$JM,.JL = X$J,.U = X$U,.m = X$m),
                  .parallel = TRUE)
# df_plot |> is.na() |> table() |> names() == "FALSE"
```
```{r grafico para reproduzir figura 3 de Hu et al 2007 e comparacao, echo=FALSE,eval=FALSE,fig.width=10}
l_p <- list()
l_p[[1]] <- df_plot |> 
  mutate(lambda=as.numeric(as.character(lambda))) |>
  filter(x>=0.03) |> 
  ggplot(aes(x=x,y=phi_x,group=lambda)) +
  geom_line(aes(color=lambda)) +
  # geom_point() +
  ylim(0,80) +
  # labs(title="lambda = c(0.01, 0.1, 1, 10)") +
  theme_classic() +
  theme(
    legend.position = c(.90, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    ) +
  coord_cartesian(expand = FALSE)

photo <- readJPEG("/home/danilo/Documentos/mestrado_Ecologia - USP/comites/1oComite/encaminhamentos/MNEI_c_Ulocal/Fig3_HUetal2007.jpg",
                  native=TRUE)
l_p[[2]] <- ggdraw() + draw_image(photo, scale = 1)
plot_grid(plotlist = l_p, ncol = 2,rel_heights = c(-0.15,1))
```
  
<!-- __Figura 1__ Comparação da figura 3 de Hu et al. 2007 e aquela obtida pela versão do código em R. Nesse exemplo as abundâncias relativas abaixo de 0.03 não foram adiconados. -->


```{r figura de phi de x com abund relat completa,echo=FALSE,eval=FALSE}
df_plot |> 
  mutate(lambda=as.numeric(as.character(lambda))) |>
  # filter(x>=0.03) |> 
  ggplot(aes(x=x,y=phi_x,group=lambda)) +
  geom_line(aes(color=lambda)) +
  # geom_point() +
  ylim(0,80) +
  # labs(title="lambda = c(0.01, 0.1, 1, 10)") +
  theme_classic() +
  theme(
    legend.position = c(.90, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    ) +
  coord_cartesian(expand = FALSE) #+
  # facet_wrap(~lambda,ncol=2)
```
  
<!-- __Figura 2__ Idem com abundância relativa entre 1/J e 1.   -->


### Investigação da equação 5 quando lambda -> 0

Um aspecto fundamental do modelo de Hu et al. (2007) é que quando m->0 a distribuição de abundância de espécies da comunidade local converge para a distribuição esperada se fosse uma metacomunidade de tamanho $J_L$ (equação 2).
  
    
$$
eq 2: \Phi(Q) = \Theta\frac{(1-Q)^{\Theta-1}}{Q}
$$
  
    
Quando m=0, a equação 5 não converge para a equação 2:

$$
\phi(x) = C\int_{1/J_M}^{1}C_1\frac{(1-x)^{\theta-1}}{x}\frac{(1-Q)^{\Theta-1}}{Q}dQ
$$
  
Eu acho estranho que nessa situação a distribuição de abundância da metacomunidade seja relevante, não? No texto eles falam que a remoção de $\bar{Q}$ é desejável pois em geral não se sabe "the ratio of the abundance of an immigrating species to the total abundance of all immigrants per unit time interval". Pra mim essa afirmação não é verdadeira, pois as inforações necessárias para se obter a equação 3 e $\bar{Q}$ são iguais. 

Já a equação 4 parece ter a propriedade de convergir para a equação 2, quando m=0:

$$
\phi(x|Q) = C_1\frac{(1-x)^{\theta-1}}x
$$
$$
C_1 = \frac{\Gamma(\theta+1)}{\Gamma(\theta)}
$$





<!-- Material Suplementar -->

```{r 1a versao MNEI, echo=FALSE, eval=FALSE}
f_MNEI_Hu_etal_2007 <- function(.J_M,.J,.U,.m){
# par. primários 
  theta_grande <- 2*.J_M*.U
  theta_pequeno <- 2*.J*.U
  lambda <- .J*.m
# C: metacommunity normalization factor
  lInt_C <- integrate(f = function(Q) ((1-Q)^(theta_grande-1))/Q,
                      lower = 1/.J_M, # only species with at least one individual (Hu et al. 2007)
                      upper = 1)
  v_C <- (lInt_C$value)^(-1)
# função que integra todos os possíveis Q para um determinado x
  f_ExpRich <- function(.x){
    f_Int <- function(Q){
    # local community
    C1 <- exp( lgamma(2 * lambda + theta_pequeno + 1) - 
                 (lgamma(2*lambda*(1-Q)+theta_pequeno) + lgamma(2*lambda*Q+1)) )
    primeiro_termo <- (1-.x)^(2*lambda*(1-Q)+theta_pequeno-1)
    segundo_termo <- .x^(2*lambda*Q-1)
    # PDF metacommunity
    metacommunity <- ((1-Q)^(theta_grande-1))/Q
    v_return <- C1 * primeiro_termo * segundo_termo * metacommunity
    return(v_return)
    }
    # integral em todos os possíveis valores de Q
    try(lInt_ <- integrate(f = f_Int,
                     upper = 1,
                     lower = 1/.J_M),
        silent = TRUE)
    try(v_ExpRich_withRelAbun_x <- lInt_$value*v_C,
        silent = TRUE)
    return(ifelse(.x == 1, 0, v_ExpRich_withRelAbun_x))
  }
df_return <- data.frame(x=seq(1/.J,1,by=1/.J))  
df_return$ExpRich <- sapply(df_return$x,f_ExpRich)
return(df_return)
}
```

