---
title: "Estatistica"
author: "Mori, Danilo"
date: "31/10/2019"
output: 
  html_document:
    toc: true
    toc_depth: 5
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE)
knitr::opts_knit$set(root.dir = "~/Documentos/Doutorado/artigo_mestrado/1A.P_MOVER/simulacao/")
setwd("~/Documentos/Doutorado/artigo_mestrado/1A.P_MOVER/simulacao/")
```

```{r pacotes}
# install.packages("remotes")
remotes::install_github("lme4/lme4")
library(optimx)
library(parallel)
library(minqa)
library(doMC)
library(GUILDS)
# library(lme4)
library(dfoptim)
library(sads)
library(merTools)
library(magrittr)
library(gridExtra)
library(ggplot2)
library(stringr)
library(tidyr)
library(plyr)
library(purrr)
library(dplyr)
```

```{r dados}
### leitura ###
df_resultados <- read.table(file="./resultados/df_resultados.csv",header = TRUE,sep = ";",dec = ".",as.is=FALSE)
### padronização ###
level_k <- unique(as.character(df_resultados$k))
df_resultados$k <- factor(as.character(df_resultados$k),levels = level_k)
levels(df_resultados$k)[19] <- "0.1"
### z score ### 
f_z <- function(x){
  m <- base::mean(x,na.rm=TRUE)
  sd <- sd(x,na.rm=TRUE)
  output <- (x-m)/sd
  return(output)
} 
# names(df_resultados)
df_resultados.z <- as.data.frame(apply(df_resultados[c("p","Ntotal","Stotal","k.0")],2,f_z))
names(df_resultados.z) <- sapply(names(df_resultados.z), function(x) paste(gsub(".0","",x),".z",sep=""))
df_resultados %<>% cbind(.,df_resultados.z)
names(df_resultados)[c(1,6)] <- c("Site","n_ref")
```


## Número de SADs refutadas

### Visualização

```{r n_ref preditoras categoricas}
# graficos
l_p <- vector("list",4)
l_p[[1]] <- ggplot(df_resultados,aes(x=MN,y=n_SAD.ref)) +
  geom_jitter() +
  geom_boxplot()
l_p[[2]] <- ggplot(df_resultados,aes(x=k,y=n_SAD.ref,group=k)) +
  geom_jitter() +
  geom_boxplot()
l_p[[3]] <- ggplot(filter(df_resultados,
                          k %in% levels(df_resultados$k)[1:10]),
                   aes(x=p,y=n_SAD.ref)) +
  geom_point() + 
  geom_smooth() + 
  facet_grid(k~MN)
l_p[[4]] <- ggplot(filter(df_resultados,
                          k %in% levels(df_resultados$k)[11:20]),
                   aes(x=p,y=n_SAD.ref)) +
  geom_point() + 
  geom_smooth() + 
  facet_grid(k~MN)
grid.arrange(l_p[[1]],l_p[[2]],l_p[[3]],l_p[[4]],
             layout_matrix = rbind(c(1,2,2,2),
                                   c(3,3,4,4),
                                   c(3,3,4,4),
                                   c(3,3,4,4))
             )

```

__Figura 1__ Número de SADs refutadas (n_SAD.ref) ~ MN, k, p

Vamos aproximar a variável por um processo binomial. Utilizamos o seguinte protocolo de ajuste dos dados  
1) comparar diferentes agrupamentos dos dados por sítios de amostragem, para um mesmo modelo cheio;  
2) os modelo cheio vão conter as variáveis p e MN e duas versões de k (continua e categorica);
3) e as 3 funções de ligação canônicas  
4) o modelo cheio mais plausível sera utilizado na seleção de variáveis
5) a seleção de variáveis contará com todas as combinações das preditoras do modelo cheio
6) avaliamos os resíduos quantílicos do modelo mais plausível


```{r n_ref comparacao modelos cheios}
l_md <- vector("list",15)
names(l_md) <- c("l k0 1|Site","l k0 MN|Site","l k0 k0*MN|Site",
                 "l kf 1|Site","l kf MN|Site",
                 "p k0 1|Site","p k0 MN|Site","p k0 k0*MN|Site",
                 "p kf 1|Site","p kf MN|Site",
                 "c k0 1|Site","c k0 MN|Site","c k0 k0*MN|Site",
                 "c kf 1|Site","c kf MN|Site")
## logito ##
l_md[[1]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (1|Site), 
                   family = "binomial",data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[2]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN|Site), 
                   family = "binomial",data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[3]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN*k.z|Site),
                   family = "binomial",data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[4]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (1|Site),
                   family = "binomial",data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[5]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (MN|Site),
                   family = "binomial",data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
## probit ##
l_md[[6]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (1|Site), 
                   family = "binomial"(link = probit),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[7]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN|Site), 
                   family = "binomial"(link = probit),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[8]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN*k.z|Site),
                   family = "binomial"(link = probit),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[9]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (1|Site),
                   family = "binomial"(link = probit),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[10]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (MN|Site),
                   family = "binomial"(link = probit),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
## cloglog
l_md[[11]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (1|Site), 
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[12]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN|Site), 
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[13]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN*k.z|Site),
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e7)))
par_md <- getME(l_md[[13]],c("theta","fixef"))
l_md[[13]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN*k.z|Site),
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e7)),
                   start = par_md)
l_md[[14]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (1|Site),
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
l_md[[15]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k * MN + (MN|Site),
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)))
AICctab(l_md,weights=T)
```

Pergunta: existe algum problema em comparar modelos que utilizaram diferentes otimizadores?
Resposta: os otimizadores diferem no algoritmo que vare o campo de parâmetros; uma vez escolhidos os parâmetros os modelos são comparados da mesma forma

Falhas de convergência:

```{r n_ref modelo cheio com convergencia}
# rotina de avaliação
# 
par_md <- getME(l_md[[13]],c("theta","fixef"))
l_md[[13]] <- glmer(cbind(n_ref,100-n_ref) ~ p.z * k.z * MN + (MN*k.z|Site),
                   family = "binomial"(link = cloglog),data=df_resultados,
                   control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e7)),
                   start = par_md)
AICctab(l_md,weights=T)
```

Resolvido

__Seleção de Variáveis__

```{r n_ref selecao de variaveis}

```

