---
title: "Artigo mestrado -  criação dos dados"
author: "Mori, Danilo Pereira"
date: "14 de fevereiro de 2018"
output: pdf_document
---

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(echo=T, warning=FALSE, message=FALSE, cache = TRUE, tidy = TRUE, include = TRUE)
```

```{r global packages and data, echo=F, message=FALSE, warning=FALSE}
library(sads)
library(gridExtra)
library(ggplot2)
library(rmutil)
library(untb)
library(doMC)
library(GUILDS)
library(magrittr)
library(plyr)
library(dplyr)

df_ad <- read.table("/home/danilo/Documentos/Doutorado/dados/df_dados.txt", sep = "\t",header = TRUE)
names(df_ad)[13] <- "sd_k"
df_SAD.obs <- read.table("/home/danilo/Documentos/Doutorado/dados/df_SADs-obs.txt", sep = "\t", header = TRUE)
```

<!--
Estrutura do arquivo:
- Prólogo  
- seleção dos sítios  
- criação da matriz de paisagem
- modelo neutro clássico  
  i) ajuste dos parâmetros do modelo de Etienne 2005 às SADs observadas  
  ii) simulação das SADs a partir dos parâmetros ajustados
  iii) comparação das SADs usando teste KS e sintese dos dados 
- modelo neutro coalescente (Rosindell et al. 2008)  
  i) seleção dos percentis de interesse da função de dispersão  
  ii) estimativa da taxa de extinção necessária para gerar a riqueza observada (U)  
  iii) simulação das SADs a partir do U estimado  
  iv) comparação das SADs usando teste KS e síntese dos dados
- organização dos dados para modelagem estatística  
- parâmetros modelo EI a partir das SADs{EE}
### Prólogo ###

  O objetivo geral dos métodos é gerar distribuições de abundância de espécies (SAD) segundo dois modelos neutros e comparar com as SADs observadas em um gradiente de cobertura vegetal. O primeiro modelo neutro é uma derivação do modelo clássico de Hubbell 2001, onde considera-se uma dinâmica ecológica ocorrendo em 'campo médio', ou seja, com o espaço implicito (Etienne et al. 2005); o segundo modelo neutro considera a distância e posição dos indivíduos na comunidade local e paisagem, permitindo simular diferentes cenários de limitação à dispersão (Rosindell et al. 2008). O fluxo de trabalho é similar em ambos os casos: ajusta-se/estima-se os parâmetros dos modelos a partir das SADs observadas, então simula-se 100 SADs réplicas segundo os respectivos modelos e compara-se SADs observadas e simuladas usando o teste de Kolmogorov-Smirnov. Em cada caso, contabiliza-se o número de réplicas em que não é possível refutar a hipótese de que as SADs são amostras de uma mesma distribuição teórica.

### Seleção dos Sítios ###
  
  Obtemos as distribuições de abundância de espécies (SAD) da base de dados TreeCo. As SADs selecionadas são oriundas de trabalhos fitossociológicas realizados na Mata Atlântica com amostragem contígua (em bloco único) de pelo menos 1 hectare (>= 1ha) e com a coordenada central da amostragem disponível e precisa. Além disso, foram descartados os sítios em que não foi possível obter um recorte de paisagem adequado à data de meu mestrado. Outro critério foi a data da amostragem, como as imagens de satélite foram tiradas em 2000 estabeleceu-se uma janela de tempo aceitável para que a paisagem da imagem fosse suficientemente similar àquela da época do estudo; para mais detalhes procurar email de Lima. 
  Por hora vou utilizar os sítios em que as simulações coalescentes (modelo neutro com espaço explicito) já haviam sido rodadas. Se for necessário/possível acrescentar sítios aos dados, a janela de código a seguir será expandida, por hora vou apenas selecionar aqueles sítios que já foram trabalhados.
--> 

Como os dados para a simulação coalescente (modelo EE) já foram obtidos no passado, aqui vou apenas simular as SADs para o modelo de espaço implícito (EI). Primeiro seleciono as SADs observadas filtradas e então ajusto o modelo de Etienne 2005 a elas e obtenho theta e m. Então simulo 100 SADs para cada conjunto de parâmetros e comparo cada réplica neutra com a respectiva SAD observada usando o teste de Kolmogorov-Smirnov e contabilizo o número de réplicas onde não foi possível refutar a hipótese nula na variável GOF.

Após a rodada de simulações e comparação realizo a conversão de parâmetros entre EI e EE. Para o modelo EI estimo U, d e seu correspondente percentil de propágulos. Para EE estimo theta e m. Na sessão da conversão de parâmetros eu descrevo melhor como realizei as conversões. Gostaria que vocês confirmassem se: a) fiz a correspondência correta entre 'd', a distância média de dispersão, e o sigma da distribuição de LaPlace; e b) se calculei corretamente o percentil correspondente ao sigma - linhas [252;267] e [296;267].

  
```{r selecao dos sitios e preparacao das SADs}
SiteCodes <- as.factor(df_ad$SiteCode) %>% levels # sitecodes de trabalho
# convertendo df_SAD.obs em lista para facilitar as operações. 
l_SAD.obs <- df_SAD.obs[,1:3] %>% filter(SiteCode %in% SiteCodes) %>% droplevels() %>% split(x=.,f=.$SiteCode) # lista de SADs obs
```

<!--
### Criação da Matriz de Paisagem ###

  Selecionado os sítios de trabalho é necessário criar a matriz de paisagem onde o modelo neutro de espaço explícito simula a dinâmica ecológica. A matriz de paisagem é oriunda de uma foto de satélite com resolução de 30X30m onde cada pixel representa a cobertura vegetal na área (podendo variar de 0-100). Quando um pixel >= 70 então consideramos que é habitat e quando não for é considerado não habitat.


```{r}

```
-->


### Modelo neutro de espaço implícito ###

Anteriormente haviamos usado o modelo de Volkov et al. 2003, contudo, para ficar coerente com o modelo de espaço explícito vamos utilizar a formula de amostragem desenvolvida por Etienne 2005, onde ele a deriva utilizando a abordagem coalescente. Para isso utilizo funções do pacote 'untb' (que precisam da biblioteca PARI/GD), que estimam os parâmetros do modelo, e uma função do pacote 'GUILDS', que simula SADs segundo o mesmo modelo.


```{r Simulacao Etienne 2005}
## Ajustando as SADs ao modelo de Etienne e armazendo os coefs em um data frame ##
# SdT: i) estimar os parâmetros usando a função optimal.params; ii) gerar lista com 100 SADs para cada; iii) comparar cada conjunto de réplicas com a SAD original usando o teste de Kolmogorov-Smirnov

## Funcao para estimar os parâmetros do modelo neutro clássico a partir da formula de Etienne 2005 ##
fitetienne <- function(SAD_){
  SAD_count <- untb::count(SAD_[,"N"])
  SAD_log.kda <- logkda.pari(SAD_count)
  par_etienne <- optimal.params(SAD_count, log.kda = SAD_log.kda)
  return(par_etienne)
}

# Estimando os parâmetros a partir da lista de SADs e armazenar os valores em um data frame #
registerDoMC(3)
df_par.Etienne <- ldply(l_SAD.obs, fitetienne, .parallel = TRUE)
df_par.Etienne %<>% mutate(J = sapply(l_SAD.obs,function(X) sum(X$N)),#tamanho do amostra
                           S = sapply(l_SAD.obs,function(X) length(X$N)), #riqueza observada
                           I = m * (J-1)/(1-m)) #convertendo parâmetros

## Simulando 100 SADs para cada conjunto de parâmetros ##
f_SAD.Etienne <- function(i,df_=df_par.Etienne,replicas=100){
  SAD.replicas <- replicate(replicas,
                            {generate.ESF(theta = df_[i,"theta"],
                                          I = df_[i,"I"],
                                          J = df_[i,"J"])
                            }
  )
}

# Lista com as SADs simuladas #
# Como a teoria de amostragem de Etienne se baseia em uma amostragem de J indivíduos e não até alcançar um determinado número de espécies (como na formula de Volkov),
# não é possível concatenar as SADs simuladas em uma matrix para cada conjunto de parâmetros, assim, na lista l_SAD.Etienne cada elemento é uma lista com 100 vetores 
# de abundância no qual podem diferir no número de spp mas não na soma total de indivíduos
l_SAD.Etienne <- llply(.data = as.list(1:nrow(df_par.Etienne)), 
                       .fun = f_SAD.Etienne, .parallel = TRUE)
```

### Comparação das SADs simuladas e observadas utilizando o teste KS ###

```{r comparacao teste KS}
# função que utiliza o teste não parâmetrico bicaudal de Kolmogorov-Smirnov
# hipótese nula: os dois vetores de abundância são amostras de uma mesma distribuição teórica
f_ks.Etienne <- function(i, SAD_obs = l_SAD.obs, SAD_sim = l_SAD.Etienne){
  f_ks.test0 <- function(SAD.obs, SAD.sim){
    a <- suppressWarnings(ks.test(x = SAD.obs,
                                  y = SAD.sim))
    a <- data.frame(KS.D = a$statistic, KS.p = a$p.value)
  }
    ks_stat <- ldply(SAD_sim[[i]],function(A) f_ks.test0(SAD.obs = SAD_obs[[i]][,"N"], SAD.sim = A))
}

# lista onde cada elemento é um df com o valor da estatística KS e o p valor associado da comparação entre a SAD obs e as réplicas neutras #
l_df.KS.Etienne <- llply(.data = as.list(1:nrow(df_par.Etienne)),
                         .fun = f_ks.Etienne, .parallel = TRUE)

## Sintetizando os dados ##
df_par.Etienne %<>% cbind(., 
                          ldply(l_df.KS.Etienne, function(x) nrow(x[x$KS.p >= 0.05,])), # GOF
                          ldply(l_df.KS.Etienne, summarise, KS.D_mean = mean(KS.D),KS.D_var = var(KS.D), KS.p_mean = mean(KS.p), KS.p_var = var(KS.p))) # estat resumo
names(df_par.Etienne)[c(1,7)] <- c("SiteCode","GOF")
```


### Auditoria dos dados ###
- Avaliação visual da autocoerência dos dados:
  
```{r auditoria dados Etienne}
# save.image(file = "/home/danilo/Documentos/Doutorado/artigo_mestrado/Rmd_e_dados/dados_completo.Rdata")
# load("/home/danilo/Documentos/Doutorado/artigo_mestrado/Rmd_e_dados/dados_completo.Rdata")
# x11()
car::scatterplotMatrix(~ GOF + KS.p_mean + KS.D_mean, 
                       reg.line = "", smoother = "" ,
                       data=df_par.Etienne, main = "Avaliação Visual de GOF e estats resumo modelo EI")
```

figura 1. GOF - bondade de ajuste (número de SADs réplicas onde não foi possível refutar a hipótese nula para cada conjunto de parâmetros); KS.p_mean - média dos 'p-values' de cada bateria de simulações; KS.D_mean - média da estatística de interesse D do teste de Kolmogorov-Smirnov, considerando uma distribuição nula de D quanto menor for D menor a probabilidade de se refutar a hipótese nula. 

Diria que está autocoerente: GOF é proporcional à KS.p_mean e KS.p_mean é inversamente proporcional à KS.D_mean. 

<!--
### Modelo neutro coalescente ###

#### estimativa dos sigmas ####

```{r}

```

#### estimativa dos U ####

```{r}

```

#### simulação das SADs e teste KS ####

```{r}

```

#### Auditoria dos Dados ####
-->


### Conversão dos parâmetros ###

  Os dois modelos neutros EE e EI são implementações da teoria geral desenvolvida por Hubbell 2001, contudo, a relação entre seus parâmetros não é direta. Aqui convertemos os parâmetros obtidos por verossimilhança utilizando o modelo EI nos parâmetros do modelo EE, U (taxa de especiação na paisagem) e d (média da dispersão). E convertemos o parâmetro U do modelo EE, estimado utilizando uma formula semi-analítica baseada na natureza genealogica do modelo coalescente dado a riqueza observada e a função de dispersão (parâmetro informado a priori), em theta e m. Para fazer a conversão entre U e theta utilizamos a definição presente em Hubbell 2001 onde: 

$theta := 2*JM*U$; 

Onde JM = número de indivíduos na paisagem = área total do recorte de paisagem (500 ha) X densidade observada (DA) X cobertura vegetal observada (p). Utilizamos essa relação para conversão reciproca de theta e U:

$theta = 2*500*DA*p*U$  
$U = theta/(2*500*DA*p)$

Para a conversão de m e d utilizamos a aproximação de caso geral apresentado por Chisholm & Linchestein 2009. Essa aproximação considera que existe apenas duas escalas: a amostra de tamanho J e uma paisagem infinita e homogenea. Em sua aproximação geral a forma da função de dispersão (ou seja, a distribuição de probabilidade que descreve a probabilidade de colonização de um propágulo em função da distância da planta progenitora) não têm influência no resultado da aproximação. Contudo, a área da amostra, relativo à média de dispersão, e a forma da amostra têm consideraveis influências na aproximação. Amostras circulares apresentam maior acuracia do que amostra retangulares e quanto maior o diâmetro da amostra em relacão à media de dispersão maior a acuracia da aproximação. Em nosso caso, selecionamos apenas trabalhos fitossociológicos que realizaram amostras em bloco único e em nossas simulações aproximamos essas amostras como um bloco único quadrado. Assim, a aproximação geral apresentada por Chisholm & Linchestein 2009:

m ~ P d /pi A; 

onde P = perímetro da amostra, d = mean dispersal distance, A = área da amostra

pode ser reescrita como:

m ~ 4l d/pi l^2; 

Onde l = lado da amostra = sqrt(A) e A = J/DA (número de indivíduos da amostra dividido pela densidade observada na amostra)

Simplificando:

m ~ 4 d / pi sqrt(J/DA)

Afim de estabelecer uma relação reciproca entre os parâmetros utilizamos a aproximação enquanto igualdade e temos:

$m = 4*d / \pi*sqrt(J/DA)$  

$d = m*\pi*sqrt(J/DA)/4$

A função de dispersão que desenvolvemos foi parâmetrizada para que informemos o desvio padrão da distribuição, assim, é possível utilizar a mesma variável com diferentes funções de probabilidade subjacente como a distribuição uniforme e a normal. 

A função de dispersão que utilizamos no modelo EE tem como distribuição de probabilidade subjacente a distribuição de Laplace, nela a variância é descrita por:

$var = 2 b ^2$

e assim,

$b=sd/sqrt(2)$

Onde b é o parâmetro escalar, que descreve a "distância média" da Laplaciana (não é a distância média per se, pois podemos entender a Laplaciana como uma exponencial espelhada, seria o equivalente ao escalar médio), portanto b = d. Assim, substituindo b na aproximação

$m = 4 * sd/(\pi sqrt(J/DA) sqrt(2)$

$sd = m sqrt(2) \pi sqrt(J/DA)/4$


Uma vez calculado sd a partir do modelo EI, estimamos a equivalente chuva de propágulos que definimos em termos de porcentagem de propágulos que se mantêm até uma determinada distãncia da planta progenitora. Aqui vale relembrar uma nota sobre a função que criamos para realizar tal tarefa:

"Há um erro que é proporcionalmente maior quando as distâncias são pequenas. Acho que é arredondamento que está na função de quantil, que faz ela andar aos saltos. Mas a boa notícia é que o erro é o mesmo para todos os kerneis. Então, apesar da função não achar exatamente o sigma necessário para que p indivíduos caiam até distance de distância, o sigma encontrado resulta na mesma distância (quantil), o que torna os sigmas calculados com os mesmos parametros p e distance equivalentes."

A distância de referência é dist_0 = 100/sqrt(DA) (lado da célula da simulação). Assim, tanto o perímetro/área da amostra quando a distância média da função de dispersão estão na mesma escala métrica. Portanto a conversão pode ser feita diretamente.

#### Conversão dos parâmetros modelo EI ####


```{r conversao de par modelo EI}
# SdT: 
#i) adicionar as informações observadas necessárias para a conversão (p e DA); 
#ii) converter theta -> U e m -> d; 
#iii) calcular a correspondente chuva de propágulos

# i) Adicionar as informações necesssárias #
# seleção dos campos de interesse 
df_EI <- df_par.Etienne[,c(1:5,7)]
# adicionando classe de modelo
df_EI$modelo<- rep("EI",nrow(df_EI))
# adicionando info para conversão dos parâmetros
df_EI %<>% inner_join(x=.,y=unique(df_ad[,c(1,5,7)]),by=c("SiteCode")) # DA e p

# ii) conversão dos parâmetros #
# conversão dos parâmetros
df_EI %<>% mutate(U = theta/(2*500*DA*p),
                  sd_k = m*sqrt(2)*pi*sqrt(J/DA)/4)

# iii) Calculando a correspondente chuva de propágulos #
# A função a seguir é uma modificação de qkernel de utility_functions, que o PI desenvolveu.
# Essa função tem como inputs: sigma e a distância de referência e como output o percentil determinado pelo número de pontos que se acumulam até
# a determinada distância dado o sigma.

# funcao para calcular a porcentagem da chuva de propagulos a partir de kernel e 
f_percentil.kernel <- function(i,df_=df_EI){
  percentilkernel<- function(sigma, density, npoints = 1e5){
      #metro na escala da simulacao 
      d_ind_MA  <- 100/sqrt(density) #tanto a metrica da paisagem quanto a distancia de referencia
      b_laplace <- sigma / sqrt(2) ## relação entre sigma e b, a variância da laplaciana
      ## gerando valores de uma distribuição laplaciana e convertendo para a distância em metros
      X_laplace <- d_ind_MA * round(rlaplace(npoints, s=b_laplace) / d_ind_MA) 
      Y_laplace <- d_ind_MA * round(rlaplace(npoints, s=b_laplace) / d_ind_MA) # idem para Y
      dist_laplace <- sqrt(X_laplace^2+Y_laplace^2) #distâncias dos pontos até a origem
      percentil <- length(dist_laplace[dist_laplace<=d_ind_MA])/length(dist_laplace) # percentil
      return(percentil)
  }
  kernel_percentil <- percentilkernel(sigma = df_[i,"sd_k"],
                                      density = df_[i,"DA"])
  return(kernel_percentil)
}
df_EI$kernel_percentil <- sapply(1:nrow(df_EI),f_percentil.kernel) #armazenando
```

-> Pontos a confirmar:
i) a maneira que utilizei 'd', da aproximação de Chisholm & Linchestein 2009, está correta dentro do uso de sigma?

Danilo: eu havia pensando que 'd' era a variância (ou escalar, correto?) da distribuilção de LaPlace, mas não sei se entendi corretamente a correspondência entre os parâmetros estimados pela aproximação(Chisholm & Linchestein, 2009) e pela distribuição de LaPlace.

ii) A função para calcular o percentil está correta? Em especial gostaria de confirmar que fiz a indexação corretamente para calcular o percentil correspondente 

```{r auditoria visual da conversao EI}
car::scatterplotMatrix(~ theta + U + m + sd_k + kernel_percentil,
                       reg.line = "", smoother = "",
                       data=df_EI, main = "Parâmetros modelo EI")
```

figura 2. Relação entre os parametros originais (theta e m) e as estimativas a partir deles (U, kernel e kernel_percentil). 


#### Conversão dos parâmetros modelo EE ####

```{r conversao de par modelo EE}
# SdT: i) info de interesse; ii) conversão de parâmetros
# i) info de interesse
df_EE <- df_ad[,c(1:2,5:8,13:14,20)]
names(df_EE)[c(4,6)] <- c("S","J") #uniformizando os nomes
df_EE$modelo<- rep("EE",nrow(df_EE))

# ii) conversão de parâmetros
df_EE %<>% mutate(theta = 2*500*DA*p*U,
                  m = 4*(sd_k/sqrt(2))/(pi*sqrt(J/DA))) 
```

-> Pontos a confirmar:
i) a questão da relação de 'd' da aproximação e do parâmetro da LaPlace é válido aqui

```{r auditoria visual da conversao EE}
car::scatterplotMatrix(~ theta + U + m + sd_k + kernel_percentil,
                       reg.line = "", smoother = "",
                       data=df_EE, main = "Parâmetros modelo EE")
```

figura 3. Relação entre os parametros originais (theta e m) e as estimativas a partir deles (U, kernel e kernel_percentil). 

Os resultados da conversão de d em m 'estouraram' os possíveis valores de m, uma vez que, m está por definição restrito à [0;1]. 

### Síntese dos dados ###

SdT: i) unir os data frames

```{r unindo os data frames}
# df_EE %>% str
# df_EI %>% str
df_resultados <- merge(x=df_EE,y=df_EI, all = TRUE) 
write.table(df_resultados,file="/home/danilo/Documentos/Doutorado/artigo_mestrado/Rmd_e_dados/df_resultados.txt",sep = "\t",row.names = FALSE)
```


### Parâmetros do modelo EI a partir das SADs{EE} ###

As SAS{EE} réplicas estão armazenadas em um data frame com quatro colunas: N, rep, SiteCode, Kernel. N contêm o vetor de abundância (a SAD); rep detona qual a réplica; as outras duas colunas são de identificação com df_ad, nota: kernel = kernel_perncentil.

Então para aproveitar o código já desenvolvido: i) filtrar as SADs pelo SiteCode; ii) transformar em lista de SADs

SdT: i) ajustar 'fitetienne' a todas as SADs{EE} réplicas para cada conjunto de parâmetros para cada Site e concatenar tudo em um data frame 


```{r}
## Qual a estrutura dos dados? (SADs{EE})##
load("/home/danilo/Documentos/Doutorado/dados/l_dados_brutos.Rdata")
df_SAD.sim <- l_dados_brutos$df_SAD.sim %>% filter(SiteCode %in% SiteCodes) %>% droplevels()
```

-> Ajustando as SADs{EE}
obs: leva um bom tempo para fazer todo o processo; estimei mais de 10 horas usando os 4 processadores do meu computador e usando a pari/GP na função fitetienne 
```{r}
# Estimando os parâmetros a partir da lista de SADs e armazenar os valores em um data frame #
registerDoMC(4)
df_EE_viaEI <- ddply(.data=df_SAD.sim, .variables = c("SiteCode","kernel","rep") , .fun=fitetienne, .parallel = TRUE)
write.table(df_EE_viaEI,file = "/home/danilo/Documentos/Doutorado/artigo_mestrado/Rmd_e_dados/df_SAD_EE-parEI-viaEI.txt",sep = "\t",row.names = FALSE)
```

alguns gráficos exploratórios

```{r}
df_EE_viaEI %>% ggplot(aes(x=SiteCode,y=theta)) + geom_boxplot() + facet_wrap(~kernel,nrow = 3)
df_temp %>% ggplot(aes(x=SiteCode,y=theta_var)) + geom_boxplot() + facet_wrap(~kernel,nrow = 3)
```


