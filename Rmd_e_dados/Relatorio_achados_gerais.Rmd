---
title: "Relatório de Achados Gerais"
author: "Mori, Danilo Pereira"
date: "9 de setembro de 2018"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE, include = TRUE, warning = FALSE,cache = TRUE)
```

```{r dados e pacotes,warning=FALSE,message=FALSE,echo=FALSE}
# library(reshape2) # para mudar formato dos dados
library(lattice)
library(gridExtra)
library(RVAideMemoire) #gráficos diagnóstico dos GLMM
library(sjPlot) #gráficos de GLMM
library(MuMIn) # para R^2
# library(gridExtra)  #pacote para gráficos
# library(ggplot2)  # idem
library(sads)
library(lme4) # pacote de criação dos modelos estatísticos
# library(bblme) # pacote para comparar os modelos, seleção per se
library(merTools) # para intervalos de previsao
library(tidyverse)
library(broom) # para manipular os modelos
library(magrittr) # p escrita
library(MASS)
library(car)
# library(plyr) 
# library(dplyr) 
df_resultados <- read_csv("/home/danilo/Documentos/Doutorado/artigo_mestrado/Rmd_e_dados/df_resultados.csv")
# df_resultados %>% str
df_resultados$MN <- factor(df_resultados$MN,levels = c("EI","EE"))
df_resultados$SiteCode <- factor(df_resultados$SiteCode)
df_resultados$k <- factor(df_resultados$k,levels=unique(df_resultados$k))
# df_resultados$k %>% contrasts()
# df_resultados$MN %>% contrasts()

#### z score ###

f_z <- function(x){
  m <- base::mean(x,na.rm=TRUE)
  sd <- sd(x,na.rm=TRUE)
  output <- (x-m)/sd
  return(output)
} 

df_resultados %<>% mutate(GOF.z = f_z(GOF),
                          DA.z = f_z(DA),
                          p.z = f_z(p),
                          S.z = f_z(S),
                          U.z = f_z(U),
                          m_.z = f_z(m_),
                          I.z = f_z(I),
                          d.z = f_z(d),
                          k.z0 = as.numeric(as.character(k)),
                          k.z = f_z(k.z0))

names(df_resultados)[1] <- "Site"

```

## Esquema Dos Métodos

### Matriz de Paisagem

i) landsat 8 => recorte de paisagem de 5 km^2 concêntrico ao sítio de amostragem (Site)
ii) ajuste de resolução da imagem tal que: densidade de pixels = densidade de indivíduos na área amostrada (DA)  
  ii.a) portanto o lado da célula (l_cel) = 100/sqrt(DA) metros
iii) se a porcentagem de cobertura vegetal do pixel for >= 70% então é unidade de habitat; caso contrário é unidade de não habitat
iv) a comunidade local é composta de N (número de indivíduos amostrados) unidades de habitat na região central do recorte de paisagem

### Função de Dispersão

i) partimos de uma distribuição de Laplace para simular a função de dispersão
ii) determinamos 12 valores de proporção de propágulos que se mantêm até l_cel metros da árvore progenitora (k): 0.99,0.95:0.50,0.25
iii) então calculou-se a distância média de dispersão (d) que gerava o correspondente percentil

### Taxa de Especiação - U

Dado matriz de paisagem e riqueza observada (S) no respectivo Site, estimamos um valor médio de taxa de especiação (U) para cada nível de k. Para está estimativa utilizamos um método semi-analítico derivado do modelo neutro de espaço explícito descrito em Rosindell et al. 2008 e estimamos 20 réplicas para cada cenário neutro. 

### Equivalência entre grandezas

__i) Parâmetros de dispersão __

Desenvolvemos uma equação que relaciona d com a probabilidade de uma unidade de habitat ser colonizada pela prole de um indivíduo de fora da comunidade local (m) e então calculamos I o número de imigrantes que competem com os indivíduos locais pelas unidades de habitat disponível (Etienne 2005).

Para calcular m a partir do desvio padrão (sd) da função de dispersão, assumimos que as áreas de amostragem são quadradas e distribuição de Laplace:

$$m = sd \frac{1 - e^{-\frac{\sqrt{2} L}{sd}} }{\sqrt{2} L}$$

Onde L = lado da área amostrada.

I se relaciona com m por:

$$ I = m (N - 1) / (1 - m)$$

__ii) Parâmetros de Diversidade__

Para cada U calculamos o respectivo theta por:

$$ \theta = U  (J_M - 1) / (1 - U) $$
Onde $J_M$ é o número de indivíduos na paisagem e é igual ao produto da área do recorte de paisagem em hectares( 500), DA e porcentagem de unidade de habitat na paisagem (p)

### Desenho Experimental

__i) Sítios de amostragem__

80 sítios de amostragem: 1 SAD observada e 1 matriz de paisagem por sítio

__ii) Predições__

_Modelo Neutro Espacialmente Explícito (EE)_

Para cada combinação de parâmetros U e d, a respectiva matriz de paisagem e o modelo descrito por Rosindell et al. (2008) geramos 100 SADs réplicas

_Modelo Neutro Espacialmente Implícito (EI)_

Para cada combinação de parâmetros $\theta$ e I e a formula de amostragem desenvolvida por Etienne (2005) geramos 100 SADs réplicas

__iii) Comparação com o observado__

Cada SAD réplica foi comparada com a respectiva SAD observada no teste de Kolmogorov-Smirnov (KS). O teste KS é um teste estatístico não paramétrico da hipótese nula de que dois vetores de abundância são amostras de uma mesma distribuição teórica. Contabilizamos o número de SADs réplicas em que não foi possível refutar a hipótese nula com alfa crítico de 0.05 na variável (GOF).

## Parâmetros de Dispersão

### d - distância média de dispersão

Perguntas: Quais as situações biológicas que estamos simulando? Em relação às médias de síndromes de dispersão em floresta intacta? E em floresta fragmentada?

#### Gráficos Exploratórios

```{r graf exp d, fig.width=10}
l_p <- vector("list",2)
l_p[[1]] <- ggplot(df_resultados,aes(x=k,y=d)) + 
  geom_jitter() +
  geom_boxplot()
l_p[[2]] <- ggplot(df_resultados,aes(x=DA,y=d)) + 
  geom_point() +
  geom_smooth(method = "loess",se=FALSE) +
  labs(y="")
do.call("grid.arrange",c(l_p,ncol=2))
```

__Figura 1__ Distância média de dispersão, k (proporção de propágulos até l_cel metros da planta progenitora) e DA (densidade observada)

#### Tabela de Seleção de Modelos

- distribuição Gamma com função de ligação 'log'

```{r selecao d}
l_md <- vector("list",length = 4)
names(l_md) <- c("k+DA","DA","k","1")
l_md[[1]] <-  glmer(d ~ k + DA.z + (1|Site),family = "Gamma"(link=log),data = df_resultados)
l_md[[2]] <-  glmer(d ~ DA.z + (1|Site),family = "Gamma"(link=log),data = df_resultados)
l_md[[3]] <-  glmer(d ~ k + (1|Site),family = "Gamma"(link=log),data = df_resultados)
l_md[[4]] <-  glmer(d ~ 1 + (1|Site),family = "Gamma"(link=log),data = df_resultados)
AICctab(l_md)
```

#### Observado e predito

```{r predito e observado d}
df_reg <- broom::augment(l_md[[1]])
df_reg %<>% mutate(predito = exp(.fitted),
                   std.resid = .resid/sd(.resid),
                   sqrt.std.resid = sqrt(std.resid))
## observado e predito ##
df_reg %>%  ggplot(aes(x=DA.z,y=d)) + geom_point() +
  geom_line(aes(y=predito),color="red") + facet_wrap(~k,ncol=3,scales="free")
```

__Figura 2__ Distância média de dispersão (d) e o predito segundo d ~ DA.z + k + (1 | Sítio), family=Gamma(log). Os pontos são as distâncias médias estimados para o determinado percentil (k) de propágulos que permanecem até l_cel metros da planta progenitora; em vermelho o predito.

#### Tabela de efeitos na escala padrão

```{r effects glmm d}
(df_effect <- data.frame(par.class = c("beta",rep("alfa",length(levels(df_resultados$k)) ) ),
                        par.VE = c("DA.z",
                                   paste("k=",levels(df_resultados$k),sep="")),
                        par.value = c(exp(fixef(l_md[[1]])[13]),
                                      exp(fixef(l_md[[1]])[1]),
                                      exp(fixef(l_md[[1]])[2:12]-fixef(l_md[[1]])[1]))
                        ))
```


#### Status

Análise da variável quase completa. Problemas de convergência não permitiram estimar os intervalos de confiança das estimativas e nem o R^2 do modelo mais plausível.

__Questões__
Qual seria k dado d, ou seja, extrapolar a relação para poder inferir qual seria k para determinadas médias de síndrome de dispersão sem precisar simular as funções de dispersão.   

Utilizando a equação matemática estimada seria necessário utilizar k enquanto variável contínua.

### I 

Perguntas: Quais são as estimativas do parâmetro de dispersão de EI obtido em campos? Quais são os valores que simulamos?

#### Gráficos Exploratórios

```{r graf exp I,fig.height=10,fig.width=10}
l_p <- vector("list",3)
l_p[[1]] <- ggplot(df_resultados,aes(x=k,y=I)) + 
  geom_jitter() +
  geom_boxplot()
l_p[[2]] <- ggplot(df_resultados,aes(x=J,y=I)) + 
  geom_point() +
  geom_smooth(method = "loess",se=FALSE) +
  labs(y="")
l_p[[3]] <- ggplot(df_resultados,aes(x=log(J),y=I)) +
  geom_point() +
  geom_smooth(method = "loess",se=FALSE) +
  facet_wrap(~k,ncol = 3,scales="free")
grid.arrange(l_p[[1]],l_p[[2]],l_p[[3]],
             layout_matrix = rbind(c(1,1,2,2),
                                   rep(3,4),
                                   rep(3,4)
                                   )
             )
```

